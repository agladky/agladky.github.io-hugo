name: CD

on:
  push:
    branches: 
      - master
    tags-ignore:
      - latest-reviews-*
  schedule:
    - cron:  '0 0 */1 * *'
  

jobs:
  update-sites:
    name: Update ru and en personal sites
    runs-on: ubuntu-latest
    steps:
    # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
    - name: Checkout raw sites
      uses: actions/checkout@v2
    - name: Fetch all tags
      run: git fetch --depth=1 origin +refs/tags/*:refs/tags/*
    - name: Checkout ru site
      uses: actions/checkout@v2
      with:
        repository: agladky/agladky.github.io
        persist-credentials: false
        fetch-depth: 0
        path: public/ru
    - name: Checkout en site
      uses: actions/checkout@v2
      with:
        repository: agladky/agladky.com
        persist-credentials: false
        fetch-depth: 0
        path: public/en
    - name: Git set up
      env:
        GIT_EMAIL: ${{ secrets.GIT_EMAIL }}
        GIT_NAME: ${{ secrets.GIT_NAME }}
      run: |
        git config --global user.email "$GIT_EMAIL"
        git config --global user.name "$GIT_NAME"

    - name: Set up Node.js
      uses: actions/setup-node@v1
      with:
        node-version: '14.x'
    - name: Cache Node.js modules
      uses: actions/cache@v1
      with:
        path: ~/.npm 
        key: ${{ runner.OS }}-node-${{ hashFiles('**/package-lock.json') }}
        restore-keys: |
          ${{ runner.OS }}-node-
          ${{ runner.OS }}-
    - name: Install Node.js dependencies
      run: npm ci
    
    - name: Set up Python
      uses: actions/setup-python@v2
      with:
        python-version: '3.7'
    - name: Load book reviews
      env:
       GOODREADS_KEY: ${{ secrets.GOODREADS_KEY }}
      run: |
        python --version
        python dev/goodreads_reviews.py --key "$GOODREADS_KEY" --path content/books

    - name: Set up Hugo
      uses: peaceiris/actions-hugo@v2
      with:
        hugo-version: '0.71.0'
        extended: true
    - name: Build Hugo
      run: hugo

    - name: Commit updated reviews
      run: |
        git add --all 
        git diff-index --quiet HEAD || (git commit -m 'Commit updated reviews' && git tag latest-reviews-$GITHUB_RUN_NUMBER)
    - name: Push updated reviews
      uses: ad-m/github-push-action@master
      with:
        tags: true
        github_token: ${{ secrets.GITHUB_TOKEN }}

    - name: Commit ru site
      run: |
        cd public/ru
        git add --all 
        git diff-index --quiet HEAD || git commit -m 'Update'
    - name: Push ru site
      uses: ad-m/github-push-action@master
      with:
        directory: public/ru
        repository: agladky/agladky.github.io
        github_token: ${{ secrets.TOKEN_SITES }}

    - name: Commit en site
      run: |
        cd public/en
        git add --all 
        git diff-index --quiet HEAD || git commit -m 'Update'
    - name: Push en site
      uses: ad-m/github-push-action@master
      with:
        directory: public/en
        repository: agladky/agladky.com
        github_token: ${{ secrets.TOKEN_SITES }}