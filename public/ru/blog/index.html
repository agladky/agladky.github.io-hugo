<!DOCTYPE html>
<html lang="ru-RU">
  <head>
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta charset="utf-8">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="Пишу про разработку, налаживание процессов команды и мои интересы.">
    <meta name="author" content="Анатолий Гладкий">
    <meta property="og:title" content="Блог Анатолия Гладкого" />
<meta property="og:description" content="Пишу про разработку, налаживание процессов команды и мои интересы." />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://agladky.ru/blog/" />
<meta property="og:updated_time" content="2016-12-13T17:10:07&#43;03:00"/><meta property="og:site_name" content="Анатолий Гладкий" />

    
  
    <base href="https://agladky.ru/">
    <title>Блог Анатолия Гладкого</title>
    <link rel="canonical" href="https://agladky.ru/blog/">
    <link rel="shortcut icon" href="https://agladky.ru/img/favicon.ico">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:400,700">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,400i,700,700i"><link rel="stylesheet" href="https://agladky.ru/css/reset.css?t=1552134872">
    <link rel="stylesheet" href="https://agladky.ru/css/pygments.css?t=1552134872">
    <link rel="stylesheet" href="https://agladky.ru/css/likely.css?t=1552134872">
    <link rel="stylesheet" href="https://agladky.ru/css/main.css?t=1552134872">
    
    <script async src="https://agladky.ru/js/likely.js"></script>
  </head>

  <body>
    <div class="page-container">
      <header class="page-header section-skin">

        <div class="page-header__up">
          <a class="page-header__avatar-link" href="https://agladky.ru/">
            <img class="page-header__avatar" src="https://agladky.ru/img/avatar.jpg">
          </a>

          <span class="page-header__name"><a class="page-header__name-link" href="https://agladky.ru/"> Анатолий Гладкий</a></span>

          <div class="page-header__lang">
              
            </div>
        </div>
        
        <div class="page-header__bottom">
          <nav class="page-header__menu">
                <span class="page-header__menu-item page-header__menu-item--selected page-header__menu-item--first">Блог</span>
          </nav>
        </div>
      </header>

      <main class="main-layout__container section-skin">
        <div class="main-layout__content">
            
  
  <article class="article-layout">
    <header class="article-head__wrapper">
      <div class="article-head">
        <a class="article-head__link" href="https://agladky.ru/blog/async-await-example/">Сравнение async await и Task.ContinueWith()</a>
      </div>
    </header>

    <div class="article-content markdown--blackfriday">
      

<p>Это краткая выжимка из рабочего доклада по работе с async/await в C#. Для наглядности, параллельно рассматривается подход с использованием блока <code>ContinueWith</code>.</p>

<h3 id="орррсновные-паттерны-асинхронного-программирования">ОРррсновные паттерны асинхронного программирования</h3>

<ul>
<li><a href="https://msdn.microsoft.com/en-us/library/ms228963.aspx">Asynchronous Programming Model (APM)</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/ms228969.aspx">Event Asynchronous Pattern (EAP)</a></li>
<li><a href="https://msdn.microsoft.com/en-us/library/hh873175.aspx">Task Asynchronous Pattern (TAP)</a>

<ul>
<li>Задачи представляют параллельные операции</li>
<li>Могут выполняться на отдельном или разных потоках.</li>
<li>Могут быть скомбинированы и выстроены в цепочку вызовов.</li>
</ul></li>
</ul>

<h3 id="async-await-синтаксическая-обертка-над-задачами">async/await — синтаксическая обертка над задачами</h3>

<ul>
<li><code>await</code> ставит на паузу текущий метод, ожидая выполнения задачи.</li>
<li>Выглядит как блокирующая (синхронная) операция.</li>
<li>Не блокирует текущий поток.</li>
<li>Выполнение продолжается в том же контексте, из которого была вызвана задача, если явно не указано иное.</li>
<li>Ключевое слово <code>async</code> указывается, чтобы среда исполнения воспринимала <code>await</code> как ключевое слово.</li>
<li><code>await</code> метод начинает выполняться синхронно. Если он уже закончил свое выполнение то новый поток не создается. Все продолжается в том же потоке. Подробнее в <a href="http://stackoverflow.com/questions/17380070/c-sharp-async-awaitable-clarification">ответе на stackoverflow.com</a>.</li>
<li><code>await</code> работает с любым типом, для которого реализован метод <code>GetAwaiter()</code>. Подробнее в статье - <a href="http://blogs.msdn.com/b/pfxteam/archive/2011/01/13/10115642.aspx">await anything</a>.</li>
</ul>

<h3 id="демонстрационное-приложение">Демонстрационное приложение</h3>

<p>Примеры показываются на тестовом Windows Form приложении. <a href="https://github.com/agladky/async_await_article">GitHub репозиторий с приложением</a>.</p>




    


<figure>
	<img src="https://agladky.ru/blog/async-await-example/images/async-await-test-window.png" alt="async/await тестовое окно">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>Асинхронные действия лежат в <code>PeopleRepositoryAsync</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">class</span> <span class="nc">PeopleRepositoryAsync</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="n">GetPeopleList</span><span class="p">()</span>
    <span class="p">{</span>        
        <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="m">2000</span><span class="p">);</span>                       
        <span class="k">return</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span>
        <span class="p">{</span>
            <span class="s">&#34;John Smith&#34;</span><span class="p">,</span>  
            <span class="s">&#34;Ivan Ivanov&#34;</span><span class="p">,</span>
            <span class="s">&#34;Joao Fetucini&#34;</span>
        <span class="p">};</span>
    <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>Метод <code>GetPeopleList()</code> асинхронно ожидает 2 секунды и возвращает список пользователей.</p>

<h3 id="первое-сравнение-tap-и-async-await-подхода">Первое сравнение TAP и async/await подхода</h3>

<h4 id="реализация-с-task-и-continuewith">Реализация с Task и ContinueWith</h4>

<p>Добавим код для получения списка пользователей в обработчик нажатия кнопки &ldquo;Fetch Data (with Task)&rdquo; - <code>buttonTask_Click</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">Task</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="n">peopleTask</span> <span class="p">=</span> <span class="n">Repository</span><span class="p">.</span><span class="n">GetPeopleList</span><span class="p">();</span>
<span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">people</span> <span class="p">=</span> <span class="n">peopleTask</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span></code></pre></div>
<p>Этот код не будет выполняться асинхронно. Он будет ожидать завершение задачи <code>peopleTask</code> в основном потоке, поэтому UI заморозится. Добавим конструкцию <code>ContinueWith(t =&gt; { })</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">peopleTask</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span>
<span class="p">{</span>
  <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">people</span> <span class="p">=</span> <span class="n">peopleTask</span><span class="p">.</span><span class="n">Result</span><span class="p">;</span>
<span class="p">});</span></code></pre></div>
<p>Теперь задача по получению пользователей выполнится асинхронно. После её завершения выполнится код в блоке <code>ContinueWith</code>.
Добавим в <code>ContinueWith</code> отображение полученных имен в <code>textBoxMain</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">textBoxMain</span><span class="p">.</span><span class="n">AppendText</span><span class="p">(</span><span class="s">$&#34;{Environment.NewLine}Person list:{Environment.NewLine}&#34;</span><span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">person</span> <span class="k">in</span> <span class="n">people</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">textBoxMain</span><span class="p">.</span><span class="n">AppendText</span><span class="p">(</span><span class="s">$&#34;- {person}{Environment.NewLine}&#34;</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<p>Если запустить приложение и нажать на &ldquo;Fetch Data (with Task)&rdquo;, то возникнет ошибка. Все потому, что код в блоке <code>ContinueWith</code> выполняется в потоке, отличном от того где находится <a href="https://habrahabr.ru/post/232169/">SynchronizationContext</a> UI потока.
Для выполнения в нужном потоке добавим в вызов метода <code>ContinueWith</code> аргумент <code>TaskScheduler.FromCurrentSynchronizationContext()</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">peopleTask</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">},</span> <span class="n">TaskScheduler</span><span class="p">.</span><span class="n">FromCurrentSynchronizationContext</span><span class="p">());</span></code></pre></div>
<p>Теперь приложение работает корректно. Перейдем к реализации этого кода с помощью ключевых слов <code>async</code> и <code>await</code>.</p>

<h4 id="реализация-с-async-await">Реализация с async/await</h4>

<p>Основное отличие от предыдущей реализации — код будет похож на синхронный. Перейдем в обработчик нажатия кнопки &ldquo;Fetch Data (with await)&rdquo; - <code>buttonAwait_Click</code>. Добавим код для получения списка пользователей:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">people</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Repository</span><span class="p">.</span><span class="n">GetPeopleList</span><span class="p">();</span></code></pre></div>
<p>В объявление метода добавим слово <code>async</code>, чтобы среда исполнения поняла что <code>await</code> это ключевое слово, а не просто переменная. Вставим без изменений код из <code>ContinueWith</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">textBoxMain</span><span class="p">.</span><span class="n">AppendText</span><span class="p">(</span><span class="s">$&#34;{Environment.NewLine}Person list:{Environment.NewLine}&#34;</span><span class="p">);</span>
<span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">person</span> <span class="k">in</span> <span class="n">people</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">textBoxMain</span><span class="p">.</span><span class="n">AppendText</span><span class="p">(</span><span class="s">$&#34;- {person}{Environment.NewLine}&#34;</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<p>Все. Приложение работает так же как и в предыдущем пункте. Код выглядит как синхронный. Выполнение продолжается в том же потоке, из которого и было вызвано.</p>

<h3 id="обработка-ошибок">Обработка ошибок</h3>

<p>Для демонстрации добавим в метод <code>GetPeopleList</code> код вызова ошибки (после <code>Task.Delay(2000)</code>):</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">throw</span> <span class="k">new</span> <span class="n">NotImplementedException</span><span class="p">(</span><span class="s">&#34;Метод не реализован!&#34;</span><span class="p">);</span></code></pre></div>
<h4 id="обработка-ошибок-для-await-метода">Обработка ошибок для await метода</h4>

<p>Сначала рассмотрим самый простой случай. Отлов и обработка ошибок для метода с <code>await</code> происходит как в синхронном коде:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">try</span>
<span class="p">{</span>
    <span class="c1">// Получение и вывод значений из репозитория
</span><span class="c1"></span><span class="p">}</span>
<span class="k">catch</span> <span class="p">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">,</span> <span class="s">&#34;ОШИБКА&#34;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">finally</span>
<span class="p">{</span>
    <span class="c1">// Критичный к выполнению код
</span><span class="c1"></span><span class="p">}</span></code></pre></div>
<p>Всё. Дополнительно писать ничего не надо, ошибка будет поймана.</p>

<h4 id="обработка-ошибок-для-task-метода">Обработка ошибок для Task метода</h4>

<p>Для метода с блоком <code>ContinueWith</code> обработать ошибки можно несколькими способами.</p>

<p>Первый, использовать еще один вызов <code>ContinueWith</code> на задаче. Вызовем <code>ContinueWith</code> с 2 дополнительными параметрами:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">peopleTask</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="c1">// Получение и вывод значений из репозитория
</span><span class="c1"></span>    <span class="p">},</span>
    <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span>
    <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnRanToCompletion</span><span class="p">,</span>
    <span class="n">TaskScheduler</span><span class="p">.</span><span class="n">FromCurrentSynchronizationContext</span><span class="p">());</span></code></pre></div>
<p>Главное — аргумент <code>TaskContinuationOptions.OnlyOnRanToCompletion</code>. Он указывает, что блок кода выполнится только если в задаче не было ошибок.</p>

<p>Теперь, код для обработки ошибки:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">peopleTask</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="kt">var</span> <span class="n">exception</span> <span class="k">in</span> <span class="n">t</span><span class="p">.</span><span class="n">Exception</span><span class="p">.</span><span class="n">Flatten</span><span class="p">().</span><span class="n">InnerExceptions</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="n">exception</span><span class="p">.</span><span class="n">Message</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">},</span>
    <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">,</span>
    <span class="n">TaskContinuationOptions</span><span class="p">.</span><span class="n">OnlyOnFaulted</span><span class="p">,</span>
    <span class="n">TaskScheduler</span><span class="p">.</span><span class="n">FromCurrentSynchronizationContext</span><span class="p">());</span></code></pre></div>
<p>Опция <code>OnlyOnFaulted</code> указывает, что код в блоке выполниться только при ошибке в задаче. Оператор <code>foreach</code> разворачивает ошибки в «плоское» состояние, т. к. все ошибки представляются в виде иерархии и оборачиваются в <code>AggregateException</code>.</p>

<p>Для имитации блока <code>finally</code>, напишем:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">peopleTask</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="c1">// Критичный к выполнению код
</span><span class="c1"></span>    <span class="p">},</span>
    <span class="n">CancellationToken</span><span class="p">.</span><span class="n">None</span><span class="p">);</span></code></pre></div>
<p>Второй способ обработки ошибок занимает меньше строк. В блок <code>ContinueWith</code> добавляется условный оператор, который проверяет статус задачи:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">peopleTask</span><span class="p">.</span><span class="n">ContinueWith</span><span class="p">(</span><span class="n">t</span> <span class="p">=&gt;</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">Status</span> <span class="p">==</span> <span class="n">TaskStatus</span><span class="p">.</span><span class="n">RanToCompletion</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Получение и вывод значений из репозитория
</span><span class="c1"></span>        <span class="p">}</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">Status</span> <span class="p">==</span> <span class="n">TaskStatus</span><span class="p">.</span><span class="n">Faulted</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// Обработка ошибок
</span><span class="c1"></span>        <span class="p">}</span>
        <span class="c1">// (finally) Критичный к выполнению код
</span><span class="c1"></span>    <span class="p">},</span>
    <span class="n">TaskScheduler</span><span class="p">.</span><span class="n">FromCurrentSynchronizationContext</span><span class="p">());</span></code></pre></div>
<h3 id="отмена-действий">Отмена действий</h3>

<p>Обновим метод <code>GetPeopleList</code> класса <code>Repository</code>. Добавим параметр <code>CancellationToken</code> и точку отмены после вызова <code>Task.Delay(2000)</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="n">GetPeopleList</span><span class="p">(</span><span class="n">CancellationToken</span> <span class="n">cancellationToken</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CancellationToken</span><span class="p">())</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="m">1500</span><span class="p">,</span> <span class="n">cancellationToken</span><span class="p">);</span>
    <span class="n">cancellationToken</span><span class="p">.</span><span class="n">ThrowIfCancellationRequested</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">};</span>
<span class="p">}</span></code></pre></div>
<p>Обратит внимание, что отмена произойдет только после ожидания в 2 секунды. Само действие <code>Task.Delay</code> не прерывается.</p>

<p>Для операции отмены используем кнопку &ldquo;Cancel request&rdquo; с обработчиком <code>buttonCancel_Click</code>. Объекту <code>CancellationToken</code> можно задать значение только при инициализации. Поэтому создадим переменную <code>CancellationTokenSource</code>. Она позволяет генерировать токены и изменять их состояние во время выполнения.</p>

<p>В класс <code>MainForm</code> добавим поле:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">private</span> <span class="n">CancellationTokenSource</span> <span class="n">_tokenSource</span><span class="p">;</span></code></pre></div>
<p>А в обработчик <code>buttonCancel_Click</code>  код для подачи токену сигнала отмены:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">_tokenSource</span><span class="p">.</span><span class="n">Cancel</span><span class="p">();</span></code></pre></div>
<h4 id="обработка-отмены-для-async-метода">Обработка отмены для async метода</h4>

<p>В обработчике <code>buttonAwait_Click</code> изменим вызов метода <code>GetPeopleList()</code>, добавив инициализацию <code>_tokenSource</code> и передав сгенерированный токен в качестве аргумента:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">_tokenSource</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CancellationTokenSource</span><span class="p">();</span>
<span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;</span> <span class="n">people</span> <span class="p">=</span> <span class="k">await</span> <span class="n">Repository</span><span class="p">.</span><span class="n">GetPeopleList</span><span class="p">(</span><span class="n">_tokenSource</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span></code></pre></div>
<p>Добавим обработку операции отмены:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">catch</span> <span class="p">(</span><span class="n">OperationCanceledException</span> <span class="n">ex</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="n">ex</span><span class="p">.</span><span class="n">Message</span><span class="p">,</span> <span class="s">&#34;Canceled&#34;</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<h4 id="обработка-отмены-для-task-метода">Обработка отмены для Task метода</h4>

<p>Для <code>buttonTask_Click</code> добавим похожий код для передачи токена:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">_tokenSource</span> <span class="p">=</span> <span class="k">new</span> <span class="n">CancellationTokenSource</span><span class="p">();</span>
<span class="n">Task</span><span class="p">&lt;</span><span class="n">List</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;&gt;</span> <span class="n">peopleTask</span> <span class="p">=</span> <span class="n">Repository</span><span class="p">.</span><span class="n">GetPeopleList</span><span class="p">(</span><span class="n">_tokenSource</span><span class="p">.</span><span class="n">Token</span><span class="p">);</span></code></pre></div>
<p>Для обработки операции отмены в блок <code>ContinueWith</code> добавим:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">Status</span> <span class="p">==</span> <span class="n">TaskStatus</span><span class="p">.</span><span class="n">Canceled</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">MessageBox</span><span class="p">.</span><span class="n">Show</span><span class="p">(</span><span class="s">&#34;Operation Canceled&#34;</span><span class="p">,</span> <span class="s">&#34;Canceled&#34;</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<h3 id="deadlocks">Deadlocks</h3>

<p>Добавим в класс <code>Repository</code> метод <code>DeadlockTestAsync()</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">async</span> <span class="n">Task</span> <span class="n">DeadlockTestAsync</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="m">1500</span><span class="p">);</span>
    <span class="n">Console</span><span class="p">.</span><span class="n">WriteLine</span><span class="p">(</span><span class="s">&#34;Done!&#34;</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<p>Вызовем этот метод в обработчике кнопки &ldquo;Deadlock&rdquo;:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">async</span> <span class="k">void</span> <span class="n">buttonDeadlock_Click</span>
<span class="p">{</span>
    <span class="n">Repository</span><span class="p">.</span><span class="n">DeadlockTestAsync</span><span class="p">().</span><span class="n">Wait</span><span class="p">();</span>
<span class="p">}</span></code></pre></div>
<p>Все. При нажатии на кнопку возникнет Deadlock. Почему? Рассмотрим по пунктам:</p>

<ol>
<li><code>DeadlockTestAsync()</code> вызывается на потоке с UI.</li>
<li><code>Task.Delay()</code> запускается в новом потоке.</li>
<li><code>await</code> захватывает <code>SynchronizationContext</code> и подключает continuation для выполнения действий после завершения.</li>
<li>Вернемся к вызову <code>DeadlockTestAsync()</code>.</li>
<li><code>Wait()</code> ждет завершение задачи в UI потоке.</li>
<li><code>Task.Delay()</code> ожидает выполнить продолжение на UI потоке.</li>
<li>Но поток в ожидание - Дедлок!</li>
<li>Все потому, что задача не вернется из <code>DeadlockTestAsync()</code>, пока не выполнится &ldquo;продолжение&rdquo;.</li>
</ol>

<p>Для избежания подобной ситуации, в библиотеках, лучше писать <code>.ConfigureAwait(false)</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">await</span> <span class="n">Task</span><span class="p">.</span><span class="n">Delay</span><span class="p">(</span><span class="m">1500</span><span class="p">).</span><span class="n">ConfigureAwait</span><span class="p">(</span><span class="k">false</span><span class="p">);</span></code></pre></div>
<p>Это позволит выполнить &ldquo;продолжение&rdquo; в том же потоке, в котором работала задача. В моем примере это будет поток, отличный от UI потока.</p>

<h3 id="полезные-ссылки">Полезные ссылки</h3>

<ul>
<li>Stephen blog - <a href="http://blog.stephencleary.com/2012/02/async-and-await.html">Async and Await</a></li>
<li>Async/Await - <a href="https://msdn.microsoft.com/en-us/magazine/jj991977.aspx">Best Practices in Asynchronous Programming</a></li>
<li>Async/Await <a href="http://blogs.msdn.com/b/pfxteam/archive/2012/04/12/10293335.aspx">FAQ</a></li>
<li><a href="http://blogs.msdn.com/b/pfxteam/archive/2011/01/13/10115642.aspx">Await anything</a></li>
</ul>

    </div>

    <footer class="article-footer__wrapper">
      <div class="article-footer__meta">
  <span title="13 декабря 2016, 17:10 &#43;0300">2016</span>
    <div class="article-footer__meta-tags">
        <a class="article-footer__meta-tag" href="tags/dotnet">dotnet</a>
      </div>
  </div>

    </footer>
  </article>

  <article class="article-layout">
    <header class="article-head__wrapper">
      <div class="article-head">
        <a class="article-head__link" href="https://agladky.ru/blog/moved-to-a-static-blog/">Перешел на статический блог</a>
      </div>
    </header>

    <div class="article-content markdown--blackfriday">
      

<p>Для разработчика, вести блог на гитхабе — отличная идея.</p>

<p>Я прошёл путь от простой хотелки перейти на статический блог до разработки шаблона и применения <a href="http://maximilyahov.ru/hello/">инфостиля</a>. Расскажу как это было.</p>

<h3 id="начало">Начало</h3>

<p>В начале года узнал о существовании <a href="https://pages.github.com/">github pages</a>. Это статический хостинг. В отличие от динамических хостингов, которые для каждого запроса генерируют страницу с ответом, на статических хранятся готовые страницы. Сайт загружается быстрее, но на сервере нельзя выполнить никаких скриптов.</p>

<p>Решил попробовать для блога. Для генерации сайта из кода использую <a href="http://gohugo.io/">hugo</a>. Быстрый, изменения моментально отображаются в браузере при запуске на локальном сервере. Понимает маркдаун для статей. Написан на го, а не руби, как рекомендуемый гитхабом <a href="https://jekyllrb.com/">jekyll</a>.</p>

<h3 id="дизайн">Дизайн</h3>

<p>Не приглянулась ни одна <a href="http://themes.gohugo.io/">тема из каталога</a>. Написал свою. Это отняло много времени. Очень. Забросил написание статей на полгода. Из полученных плюсов — прокачал навыки верстки, получил опыт работы с CSS препроцессором <a href="http://lesscss.org/">less</a>. Узнал о <a href="https://ru.bem.info/">БЭМ методологии</a>, но не успел применить. Не пожалел что потратил на тему столько времени.</p>

<p>Как перфекционист, полировал бы тему и дальше. Но, в какой-то момент понял — надо выпускать. Последовал <a href="https://www.artlebedev.ru/kovodstvo/sections/167/">методу прогрессивного джипега</a> — доделал критическое, остальное по мере сил и времени. Из крупного — не стал доделывать страницу о себе. Она пока повисит в закрепленном посте у которого, при выходе нового, обновляется время, чтобы он оставался вверху. Без решения остановки, делал бы тему еще полгода и не выпускал новые посты.</p>

<h3 id="редактура">Редактура</h3>

<p>Во время перехода, стал интересоваться <a href="http://maximilyahov.ru/">редактурой Максима Ильяхова</a>. Прошел <a href="http://glvrd.us9.list-manage2.com/subscribe?u=89138ced008e0282fe335b3a8&amp;id=67512905d0">базовый курс</a>, подписался на <a href="http://maximilyahov.ru/glvrd-pro/">продвинутый</a>. Кайфую. Исчезла тяга к графоманству, начал четче выражать мысли в письме. Из минусов — вокруг оказалось много плохого текста. Тянет переписывать. Начал с себя. Переписал посты в блоге. Это отодвинуло время перехода на полгода. Дольше всего редактировал пост о <a href="http://www.agladky.ru/blog/my-first-python-script/">первом скрипте на питоне</a>. Но, результатом доволен. Можете прогнать на <a href="http://glvrd.ru/">glvrd.ru</a> — рейтинг больше 9.</p>

<h3 id="ощущения">Ощущения</h3>

<p>Мне понравилось писать свой блог для статического хостинга. Никаких админок, только редактор и код. Он также подойдет для небольшого сайта о компании или продукте. Буду и дальше использовать <a href="https://pages.github.com/">github pages</a>.</p>

    </div>

    <footer class="article-footer__wrapper">
      <div class="article-footer__meta">
  <span title="10 сентября 2016, 11:13 &#43;0300">2016</span>
    <div class="article-footer__meta-tags">
        <a class="article-footer__meta-tag" href="tags/%D0%B1%D0%BB%D0%BE%D0%B3">блог</a>
      </div>
  </div>

    </footer>
  </article>

  <article class="article-layout">
    <header class="article-head__wrapper">
      <div class="article-head">
        <a class="article-head__link" href="https://agladky.ru/blog/listen-razbor-poletov/">Послушайте «Разбор полетов» 105</a>
      </div>
    </header>

    <div class="article-content markdown--blackfriday">
      <p>Не каждый день встретишь человека с такой уверенностью в своей правоте и идущего против системы.</p>

<p>Послушал <a href="http://razbor-poletov.com/2016/03/episode-105.html">105 серию подкаста «Разбор полетов»</a>. Веселый выпуск. Гость, Егор Бугаенко, убеждён что большинство использует ООП неправильно. Не понимают парадигмы. Ведущие с ним не соглашаются. Море троллинга и споров. Послушайте, узнаете как далеко можно зайти в своих убеждениях.</p>

<p>После, советую пролистать <a href="http://www.yegor256.com/">блог Егора</a>. Прав он или нет, но интересные мысли почерпнете.</p>

    </div>

    <footer class="article-footer__wrapper">
      <div class="article-footer__meta">
  <span title="5 сентября 2016, 22:14 &#43;0300">2016</span>
    <div class="article-footer__meta-tags">
        <a class="article-footer__meta-tag" href="tags/%D0%BF%D0%BE%D0%B4%D0%BA%D0%B0%D1%81%D1%82%D1%8B">подкасты</a>
      </div>
  </div>

    </footer>
  </article>

  <article class="article-layout">
    <header class="article-head__wrapper">
      <div class="article-head">
        <a class="article-head__link" href="https://agladky.ru/blog/drag-and-drop-in-watch-windows/">Перетаскивание кода в окно Watch в Visual Studio</a>
      </div>
    </header>

    <div class="article-content markdown--blackfriday">
      <p>Маленькая хитрость, которую я открыл совсем недавно. Для добавления переменной в окно Watch, необязательно вводить туда значение или копировать и вставлять из редактора. Просто перетащите её:</p>




    


<figure>
	<img src="https://agladky.ru/blog/drag-and-drop-in-watch-windows/images/CopyWatch.gif" alt="Перетаскивание переменной в окно watch">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>Второе окно Watch 2 обрело для меня смысл и, главное, легкость в использовании:</p>




    


<figure>
	<img src="https://agladky.ru/blog/drag-and-drop-in-watch-windows/images/CopyWatch2w.gif" alt="Перетаскивание переменной в окно watch 2">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>Сайт с полезными советами для .Net разработчиков — <a href="http://dailydotnettips.com/">dailydotnettips.com</a>.</p>

    </div>

    <footer class="article-footer__wrapper">
      <div class="article-footer__meta">
  <span title="25 февраля 2016, 13:10 &#43;0300">2016</span>
    <div class="article-footer__meta-tags">
        <a class="article-footer__meta-tag" href="tags/dotnet">dotnet</a>
      
        <a class="article-footer__meta-tag" href="tags/ide">ide</a>
      </div>
  </div>

    </footer>
  </article>

  <article class="article-layout">
    <header class="article-head__wrapper">
      <div class="article-head">
        <a class="article-head__link" href="https://agladky.ru/blog/new-if-null-operator-csharp-6/">Новый оператор ?. в C# 6</a>
      </div>
    </header>

    <div class="article-content markdown--blackfriday">
      

<p>Одно из нововведений в С# 6 — оператор <code>?.</code>. Давайте рассмотрим, где и как его использовать.</p>

<h3 id="преобразование-цепочки-вызовов">Преобразование цепочки вызовов</h3>

<p>С новым оператором уменьшается количество проверок на <code>null</code> в цепочке вызовов:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">documentName</span> <span class="p">=</span> <span class="n">taskManager</span><span class="p">.</span><span class="n">CurrentTask</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="k">null</span> <span class="p">:</span>
  <span class="p">(</span><span class="n">taskManager</span><span class="p">.</span><span class="n">CurrentTask</span><span class="p">.</span><span class="n">GetDocument</span><span class="p">()</span> <span class="p">==</span> <span class="k">null</span> <span class="p">?</span> <span class="k">null</span> <span class="p">:</span>
    <span class="n">taskManager</span><span class="p">.</span><span class="n">CurrentTask</span><span class="p">.</span><span class="n">GetDocument</span><span class="p">().</span><span class="n">Name</span><span class="p">);</span></code></pre></div>
<p>Перепишем в одну строчку используя <code>?.</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">documentName</span> <span class="p">=</span> <span class="n">taskManager</span><span class="p">.</span><span class="n">CurrentTask</span><span class="p">?.</span><span class="n">GetDocument</span><span class="p">()?.</span><span class="n">Name</span><span class="p">;</span></code></pre></div>
<p><code>documentName</code> примет значение <code>null</code>, если <code>CurrentTask</code>, <code>GetDocument()</code> или <code>Name</code> вернет <code>null</code>.</p>

<p>Второй вариант компактнее. Также, в первом блоке кода метод <code>GetDocument()</code> вызывается два раза, а во втором — один. Для реализации подобного поведения без использования <code>?.</code> нужна дополнительная переменная для сохранения значения из <code>GetDocument()</code>.</p>

<h3 id="использование-с-индексатором">Использование с индексатором</h3>

<p>Рассмотрим получение значения из коллекции по индексу, с проверкой набора значений на <code>null</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">tasks</span> <span class="p">=</span> <span class="p">(</span><span class="n">taskManager</span><span class="p">.</span><span class="n">Tasks</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span> <span class="p">?</span> <span class="n">taskManager</span><span class="p">.</span><span class="n">Tasks</span><span class="na">[index]</span> <span class="p">:</span> <span class="k">null</span><span class="p">;</span></code></pre></div>
<p>С новым оператором проверка на <code>null</code> условным оператором не расписывается. Бонус — выражение в 2 раза короче:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">tasks</span> <span class="p">=</span> <span class="n">taskManager</span><span class="p">.</span><span class="n">Tasks</span><span class="p">?</span><span class="na">[index]</span><span class="p">;</span></code></pre></div>
<h3 id="оборачивание-в-нулевые-типы">Оборачивание в нулевые типы</h3>

<p>Результат выполнения <code>String.Equals()</code> — <code>bool</code>. Скомпилируется ли следующий код?</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">public</span> <span class="k">void</span> <span class="n">Main</span><span class="p">()</span>
<span class="p">{</span>
  <span class="n">String</span> <span class="n">str</span> <span class="p">=</span> <span class="s">&#34;x&#34;</span><span class="p">;</span>
  <span class="kt">bool</span> <span class="n">result</span> <span class="p">=</span> <span class="n">str</span><span class="p">?.</span><span class="n">Equals</span><span class="p">(</span><span class="s">&#34;x&#34;</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<p>Нет. Возникнет ошибка: <code>Cannot implicitly convert type ’bool?’ to ’bool’</code>. Такое поведение ожидаемо, так как <code>str?.Equals(&quot;x&quot;)</code> вернет <code>null</code> если переменная <code>str</code> не инициализирована и <code>bool</code> в остальных случаях.</p>

<p>В подобных ситуациях, при использовании оператора <code>?.</code>, возвращаемый тип функции <code>T</code> будет оборачиваться в <code>Nullable&lt;T&gt;</code>.</p>

<h3 id="использование-в-условии">Использование в условии</h3>

<p>Есть задача — проверить коллекцию на наличие в ней элементов. Типичный код:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">if</span> <span class="p">(</span><span class="n">taskManager</span><span class="p">.</span><span class="n">Tasks</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">&amp;&amp;</span> <span class="n">taskManager</span><span class="p">.</span><span class="n">Tasks</span><span class="p">.</span><span class="n">Any</span><span class="p">())</span>
  <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&#34;Tasks has items!&#34;</span><span class="p">);</span></code></pre></div>
<p>Попробуем переписать:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">if</span> <span class="p">(</span><span class="n">taskManager</span><span class="p">.</span><span class="n">Tasks</span><span class="p">?.</span><span class="n">Any</span><span class="p">())</span>
  <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&#34;Tasks has items!&#34;</span><span class="p">);</span></code></pre></div>
<p>Код не скомпилируется. Как написано в предыдущем пункте, <code>taskManager.Tasks?.Any()</code> вернет <code>Nullable&lt;bool&gt;</code> тип, который нельзя однозначно трактовать в условии <code>if</code>. Дополним код:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">if</span> <span class="p">(</span><span class="n">taskManager</span><span class="p">.</span><span class="n">Tasks</span><span class="p">?.</span><span class="n">Any</span><span class="p">()</span> <span class="p">==</span> <span class="k">true</span><span class="p">)</span>
  <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&#34;Tasks has items!&#34;</span><span class="p">);</span></code></pre></div>
<p>Работает. И на одно условие стало меньше.</p>

<p>Комбинируя с оператором <code>??</code>, перепишем в эквивалентный код:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">if</span> <span class="p">(</span><span class="n">taskManager</span><span class="p">.</span><span class="n">Tasks</span><span class="p">?.</span><span class="n">Any</span><span class="p">()</span> <span class="p">??</span> <span class="k">false</span><span class="p">)</span>
  <span class="n">Console</span><span class="p">.</span><span class="n">Write</span><span class="p">(</span><span class="s">&#34;Tasks has items!&#34;</span><span class="p">);</span></code></pre></div>
<h3 id="комбинация-с-оператором">Комбинация с оператором ??</h3>

<p>Оператор <code>??</code> называется оператором объединения со значением <code>null</code>. Если операция возвращает <code>null</code>, оператор <code>??</code> подставит значение из правой части выражения.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">documentName</span> <span class="p">=</span> <span class="n">taskManager</span><span class="p">.</span><span class="n">CurrentTask</span><span class="p">?.</span><span class="n">GetDocument</span><span class="p">()?.</span><span class="n">Name</span> <span class="p">??</span> <span class="s">&#34;No Name&#34;</span><span class="p">;</span></code></pre></div>
<p>Если <code>CurrentTask</code>, <code>GetDocument()</code> или <code>Name</code> вернет <code>null</code>, то переменная примет значение <code>&quot;No Name&quot;</code>.</p>

<h3 id="использование-с-делегатами">Использование с делегатами</h3>

<p>Стандартный код для вызова делегата:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="kt">var</span> <span class="n">handler</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">PropertyChanged</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="n">handler</span> <span class="p">!=</span> <span class="k">null</span><span class="p">)</span>
  <span class="n">handler</span><span class="p">(</span><span class="err">…</span><span class="p">)</span></code></pre></div>
<p>Используя <code>?.</code>, больше не надо каждый раз писать такой код, делегат вызывается одной строкой:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">PropertyChanged</span><span class="p">?.</span><span class="n">Invoke</span><span class="p">(</span><span class="n">e</span><span class="p">)</span></code></pre></div>
<p>Компилятор создает код для вычисления PropertyChanged только один раз, запоминая результат во временной переменной.</p>

<p>Обратите внимание, следующий код вызовет ошибку:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">PropertyChanged</span><span class="p">?(</span><span class="n">e</span><span class="p">)</span></code></pre></div>
<p>Вызов метода <code>Invoke</code> обязателен.</p>

<h3 id="полезные-ссылки">Полезные ссылки</h3>

<ul>
<li><a href="https://msdn.microsoft.com/ru-ru/library/ms173224.aspx">Оператор ??</a></li>
<li><a href="https://msdn.microsoft.com/ru-RU/library/dn986595.aspx">Операторы ?. и ?</a></li>
<li><a href="https://msdn.microsoft.com/ru-ru/magazine/dn802602.aspx">Новый и более совершенный C# 6.0</a></li>
</ul>

    </div>

    <footer class="article-footer__wrapper">
      <div class="article-footer__meta">
  <span title="17 февраля 2016, 13:10 &#43;0300">2016</span>
    <div class="article-footer__meta-tags">
        <a class="article-footer__meta-tag" href="tags/dotnet">dotnet</a>
      </div>
  </div>

    </footer>
  </article>

  <article class="article-layout">
    <header class="article-head__wrapper">
      <div class="article-head">
        <a class="article-head__link" href="https://agladky.ru/blog/differences-comparison-operators-in-javascript/">Различия операторов == и === в JavaScript</a>
      </div>
    </header>

    <div class="article-content markdown--blackfriday">
      <p>Каждый раз я с опаской заменяю <code>==</code> на <code>===</code> — боюсь сломать логическое выражение. Ведь оператор равенства <code>==</code> реализует много неявной логики по сравнению значений, чем мог воспользоваться предыдущий разработчик.</p>

<p>Операторы <code>==</code> и <code>===</code> проверяют значения на совпадение, используя различные определения совпадения. Оператор идентичности (identity) <code>===</code> проверяет операнды на «идентичность», руководствуясь строгим определением совпадения. Оператор равенства (equality) <code>==</code> проверяет по менее строгим правилам, допускающим преобразования типов.</p>

<p>Оператор идентичности <code>===</code> вычисляет значения своих операндов, а затем сравнивает, без преобразования типов. Он руководствуется правилами:</p>

<ul>
<li>Если у значений разные типы — они не идентичны.</li>
<li>Если оба значения или <code>null</code> или <code>undefined</code> — они идентичны.</li>
<li>Если оба значения или <code>true</code> или <code>false</code> — они идентичны.</li>
<li>Если одно или оба значения — <code>NaN</code> — они не идентичны. (Значение <code>NaN</code> никогда не идентично никакому значению, даже самому себе. Чтобы проверить значение <code>x</code> на <code>NaN</code>, используйте выражение <code>x !== x</code>. Только для <code>NaN</code> такая проверка вернет <code>true</code>).</li>
<li>Если оба операнда это числа с одним и тем же значением — они идентичны. Если одно число равно <code>0</code>, а другое <code>-0</code>, они также идентичны.</li>
<li>Если оба значения это строки и содержат одни и те же 16-битные значения в одинаковых позициях — они идентичны. Две строки могут иметь один и тот же смысл и одинаково выглядеть на экране, но содержать отличающиеся последовательности 16-битных значений. Интерпретатор JavaScript не выполняет нормализацию символов юникода, поэтому подобные пары строк не считаются операторами <code>===</code> и <code>==</code> ни равными, ни идентичными.</li>
<li>Если оба значения ссылаются на один и тот же объект, массив или функцию — они идентичны. Если они ссылаются на различные объекты — они не идентичны, даже при идентичных свойствах.</li>
</ul>

<p>Оператор равенства <code>==</code> похож на оператор идентичности, но он использует менее строгие правила. Если у значений разные типы — они преобразуются и сравниваются:</p>

<ul>
<li>Если у значений одинаковый тип, они проверяются на идентичность, как описано выше.</li>
<li>Если значения не относятся к одному типу, оператор <code>==</code> считает их равными, при следующих правилах:

<ul>
<li>Если одно значение <code>null</code>, а другое <code>undefined</code> — они равны.</li>
<li>Если одно значение число, а другое строка, то строка преобразуется в число и выполняется сравнение.</li>
<li>Если одно значение — <code>true</code>, оно перед сравнением преобразуется в <code>1</code>. Если — <code>false</code>, оно преобразуется в <code>0</code> и сравнение выполняется снова.</li>
<li>Если одно значение число или строка, а другое — объект, то перед сравнением объект преобразуется в простой тип. Встроенные классы преобразуются методом <code>valueOf()</code>, если не получилось, то <code>toString()</code>. Класс <code>Date</code> всегда выполняет преобразование <code>toString()</code>. Не базовые объекты джаваскрипта сами определяют способ преобразования в простые типы.</li>
<li>Любые другие комбинации значений не равны.</li>
</ul></li>
</ul>

<p>Правила преобразования типов и сравнения значений для оператора равенства <code>==</code> сложные и труднозапоминаемые. Интересные случаи:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="s1">&#39;&#39;</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span>           <span class="c1">// false
</span><span class="c1"></span><span class="mi">0</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span>             <span class="c1">// true
</span><span class="c1"></span><span class="mi">0</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span>            <span class="c1">// true
</span><span class="c1"></span>
<span class="kc">false</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span>    <span class="c1">// false
</span><span class="c1"></span><span class="kc">false</span> <span class="o">==</span> <span class="s1">&#39;0&#39;</span>        <span class="c1">// true
</span><span class="c1"></span>
<span class="kc">false</span> <span class="o">==</span> <span class="kc">undefined</span>  <span class="c1">// false
</span><span class="c1"></span><span class="kc">false</span> <span class="o">==</span> <span class="kc">null</span>       <span class="c1">// false
</span><span class="c1"></span><span class="kc">null</span> <span class="o">==</span> <span class="kc">undefined</span>   <span class="c1">// true
</span><span class="c1"></span>
<span class="s1">&#39; \t\r\n &#39;</span> <span class="o">==</span> <span class="mi">0</span>     <span class="c1">// true
</span><span class="c1"></span></code></pre></div>
<p>Особый случай — сравнение литерал с объектом:</p>
<div class="highlight"><pre class="chroma"><code class="language-js" data-lang="js"><span class="s2">&#34;abc&#34;</span> <span class="o">==</span> <span class="k">new</span> <span class="nb">String</span><span class="p">(</span><span class="s2">&#34;abc&#34;</span><span class="p">)</span>    <span class="c1">// true
</span><span class="c1"></span><span class="s2">&#34;abc&#34;</span> <span class="o">===</span> <span class="k">new</span> <span class="nb">String</span><span class="p">(</span><span class="s2">&#34;abc&#34;</span><span class="p">)</span>   <span class="c1">// false
</span><span class="c1"></span></code></pre></div>
<p>Здесь, оператор <code>==</code> проверяет значение объектов и возвращает <code>true</code>. Оператор <code>===</code> возвращает <code>false</code>, т.к. у объектов различные типы. Какое поведение корректно? Зависит от того, что сравнивать. Но лучше обойти вопрос, и не использовать конструктор для создания строковых объектов.</p>

<p>В заключении — таблицы сравнения значений для операторов равенства и идентичности с сайта <a href="http://dorey.github.io/JavaScript-Equality-Table/">dorey.github.io</a>.</p>

<p>Для оператора <code>==</code> (или <code>!=</code>):</p>




    


<figure>
	<img src="https://agladky.ru/blog/differences-comparison-operators-in-javascript/images/two-equals_hu212cde2255db6676049ff5f07f39e775_88287_1000x0_resize_q100_box_2.png" alt="Таблица сравнения значений для оператора ==">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>Для оператора <code>===</code> (или <code>!==</code>):</p>




    


<figure>
	<img src="https://agladky.ru/blog/differences-comparison-operators-in-javascript/images/three-equals_hu212cde2255db6676049ff5f07f39e775_85688_1000x0_resize_q100_box_2.png" alt="Таблица сравнения значений для оператора ==">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>Из таблиц следует вывод, что поведение <code>==</code> не очевидно и может только запутать. Используя <code>===</code> можно быть уверенным в возвращаемом значении.</p>

<p>Интересная статья: <a href="http://www.2ality.com/2011/12/strict-equality-exemptions.html">When is it OK to use == in JavaScript?</a></p>

    </div>

    <footer class="article-footer__wrapper">
      <div class="article-footer__meta">
  <span title="2 февраля 2016, 13:10 &#43;0300">2016</span>
    <div class="article-footer__meta-tags">
        <a class="article-footer__meta-tag" href="tags/javascript">javascript</a>
      </div>
  </div>

    </footer>
  </article>

  <article class="article-layout">
    <header class="article-head__wrapper">
      <div class="article-head">
        <a class="article-head__link" href="https://agladky.ru/blog/what-is-a-monad-on-csharp-example/">Что такое монады на примере C#</a>
      </div>
    </header>

    <div class="article-content markdown--blackfriday">
      

<p>Конспект — вольный перевод одного из лучших циклов статей о монадах. Эрик Липперт, на протяжении 13 глав, отвечает на вопрос:</p>

<blockquote>
<p>Я C# разработчик без опыта в «функциональном программировании». Что такое «монада» и как можно её использовать для себя?</p>
</blockquote>

<p>Оригинальный цикл статей доступен по <a href="http://ericlippert.com/category/monads/">тегу monads</a>.</p>

<h3 id="часть-первая">Часть первая</h3>

<p>Монада в функциональном программировании — абстракция линейной цепочки связанных вычислений. Её основное назначение — инкапсуляция функций с побочным эффектом от чистых функций, а точнее, их выполнений от вычислений. (Определение из википедии).</p>

<p>«Шаблон монады» это еще один шаблон для типов. Как, например, одиночка (синглтон).</p>

<h3 id="часть-вторая">Часть вторая</h3>

<ul>
<li><code>Nullable&lt;T&gt;</code> — представляет объект типа T, который может быть <code>null</code> (в дальнейшем, подразумевается что <code>Nullable&lt;T&gt;</code> может работать с любым типом данных).</li>
<li><code>Func&lt;T&gt;</code> — представляет объект типа T, который будет вычислен отложено (в дальнейшем, для большей ясности, будет использоваться делегат <code>delegate T OnDemand&lt;T&gt;();</code>).</li>
<li><code>Lazy&lt;T&gt;</code> — представляет объект типа T, который будет вычислен отложено в первый раз, а после, закеширован.</li>
<li><code>Task&lt;T&gt;</code> — представляет объект типа T, который будет вычислен асинхронно и будет доступен в будущем, если уже не вычислен.</li>
<li><code>IEnumerable&lt;T&gt;</code> — представляет упорядоченную, доступную только для чтения последовательность от нуля и более элементов типа T.</li>
</ul>

<h3 id="часть-третья">Часть третья</h3>

<p>Первое требование для монад: «если <code>M&lt;T&gt;</code> это тип-монада, тогда должен быть простой путь по превращению любого значение типа <code>T</code> в значение типа <code>M&lt;T&gt;</code>». Например:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">CreateSimpleNullable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="k">new</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">item</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="n">OnDemand</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">CreateSimpleOnDemand</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span> <span class="n">item</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">CreateSimpleSequence</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">item</span><span class="p">)</span> <span class="p">{</span> <span class="k">yield</span> <span class="k">return</span> <span class="n">item</span><span class="p">;</span> <span class="p">}</span></code></pre></div>
<p>Кажется, что второе требование просто сформулировать: «из монады <code>M&lt;T&gt;</code>можно получить значение типа <code>T</code>». Но не все так однозначно. Начнем с очень специфичного вопроса. Можно легко прибавить единицу к целочисленному типу, но как «прибавить единицу» к типу-монаде обернутого вокруг целочисленного типа?</p>

<p>Для <code>Nullable&lt;T&gt;</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">AddOne</span><span class="p">(</span><span class="n">Nullable</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">nullable</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nullable</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">int</span> <span class="n">unwrapped</span> <span class="p">=</span> <span class="n">nullable</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="p">=</span> <span class="n">unwrapped</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">CreateSimpleNullable</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>  
    <span class="k">return</span> <span class="k">new</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;();</span>
<span class="p">}</span></code></pre></div>
<p>То есть можно развернуть, произвести операцию и завернуть? Не совсем, если проделать ту же операцию для <code>OnDemand&lt;T&gt;()</code>, который обернут вокруг <code>DateTime.Now.Seconds</code>, то получится статическое значение. Поэтому проделанную операцию вместе с разворачиванием необходимо завернуть в функцию, как показано здесь:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">OnDemand</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">AddOne</span><span class="p">(</span><span class="n">OnDemand</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">onDemand</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span>
  <span class="p">{</span>
    <span class="kt">int</span> <span class="n">unwrapped</span> <span class="p">=</span> <span class="n">onDemand</span><span class="p">();</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="p">=</span> <span class="n">unwrapped</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span></code></pre></div>
<p>То есть тип монады по требованию, не просто оболочка вокруг значения. Она производит объект, структура которого кодирует последовательность операций, которые будут происходить по требованию. Это одна из особенностей, которая делает монады полезными. Но об этом позже.</p>

<p>Для <code>Lazy&lt;T&gt;</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">Lazy</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">AddOne</span><span class="p">(</span><span class="n">Lazy</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">lazy</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">Lazy</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(()</span> <span class="p">=&gt;</span>
  <span class="p">{</span>
    <span class="kt">int</span> <span class="n">unwrapped</span> <span class="p">=</span> <span class="n">lazy</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="p">=</span> <span class="n">unwrapped</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">});</span>
<span class="p">}</span></code></pre></div>
<p>Для <code>Task&lt;T&gt;</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">async</span> <span class="k">static</span> <span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">AddOne</span><span class="p">(</span><span class="n">Task</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">task</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">unwrapped</span> <span class="p">=</span> <span class="k">await</span> <span class="n">task</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">result</span> <span class="p">=</span> <span class="n">unwrapped</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span></code></pre></div>
<p>И, наконец, для <code>IEnumerable&lt;T&gt;</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">AddOne</span><span class="p">(</span><span class="n">IEnumerable</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">sequence</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">foreach</span><span class="p">(</span><span class="kt">int</span> <span class="n">unwrapped</span> <span class="k">in</span> <span class="n">sequence</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="p">=</span> <span class="n">unwrapped</span> <span class="p">+</span> <span class="m">1</span><span class="p">;</span>
    <span class="k">yield</span> <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>Таким образом, одно из полезных правил для шаблона монад — добавление единицы к завернутому целочисленному типу производит другой завернутый целочисленный тип, с сохранением всех особенностей.</p>

<h3 id="часть-четвертая">Часть четвертая</h3>

<p>Напишем метод, который позволит делать оболочку над любыми <code>Nullable&lt;T&gt;</code> функциями, а не только операцией по добавлению единицы:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">ApplyFunction</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span>
  <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">nullable</span><span class="p">,</span>
  <span class="n">Func</span><span class="p">&lt;</span><span class="n">T</span><span class="p">,</span> <span class="n">T</span><span class="p">&gt;</span> <span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nullable</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">T</span> <span class="n">unwrapped</span> <span class="p">=</span> <span class="n">nullable</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
    <span class="n">T</span> <span class="n">result</span> <span class="p">=</span> <span class="n">function</span><span class="p">(</span><span class="n">unwrapped</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">result</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;();</span>
<span class="p">}</span></code></pre></div>
<p>Теперь метод <code>AddOne(...)</code> будет выглядеть так:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">AddOne</span><span class="p">(</span><span class="n">Nullable</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;</span> <span class="n">nullable</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">ApplyFunction</span><span class="p">(</span><span class="n">nullable</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">x</span> <span class="p">+</span> <span class="m">1</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<p>Но, допустим, мы хотим функцию которая принимает тип <code>int</code> и возвращает <code>double</code>. Например, поделить 2 целых числа и получить результат типа <code>double</code>. Для этого, перепишем метод <code>ApplyFunction</code> в следующий вид:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="n">ApplyFunction</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;(</span>
  <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">A</span><span class="p">&gt;</span> <span class="n">nullable</span><span class="p">,</span>
  <span class="n">Func</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;</span> <span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nullable</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">A</span> <span class="n">unwrapped</span> <span class="p">=</span> <span class="n">nullable</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
    <span class="n">R</span> <span class="n">result</span> <span class="p">=</span> <span class="n">function</span><span class="p">(</span><span class="n">unwrapped</span><span class="p">);</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;(</span><span class="n">result</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;();</span>
<span class="p">}</span></code></pre></div>
<p>Для остальных типов, можно сделать по аналогии. По сути, получился способ превращения типов из <code>A</code> в <code>R</code> в монадические типы из <code>М&lt;А&gt;</code> в <code>М&lt;R&gt;</code> такие, что сохраняется действие функции и значения, предоставляемые в монадическом («расширенном») типе.</p>

<h3 id="часть-пятая">Часть пятая</h3>

<p>Ранее было указано, что можно взять любую функцию с одним параметром и любым не пустым возвращаемым типом и применить эту функцию к монаде с возвращаемым типом <code>M&lt;R&gt;</code>. Любой возвращаемый тип, так? Предположим, что есть функция с одним параметром:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;</span> <span class="n">SafeLog</span><span class="p">(</span><span class="kt">int</span> <span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;(</span><span class="n">Math</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="n">x</span><span class="p">));</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;();</span>
<span class="p">}</span></code></pre></div>
<p>Обычная функция с одним параметром. Значит, ее можно применить к <code>Nullable&lt;int&gt;</code> и получить обратно&hellip; <code>Nullable&lt;Nullable&lt;double&gt;&gt;</code>! Это неправильно.</p>

<p>Создадим новую версию <code>ApplyFunction</code>, которая избегает описанной проблемы:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="n">ApplySpecialFunction</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;(</span>
  <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">A</span><span class="p">&gt;</span> <span class="n">nullable</span><span class="p">,</span>
  <span class="n">Func</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;&gt;</span> <span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">nullable</span><span class="p">.</span><span class="n">HasValue</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">A</span> <span class="n">unwrapped</span> <span class="p">=</span> <span class="n">nullable</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
    <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="n">result</span> <span class="p">=</span> <span class="n">function</span><span class="p">(</span><span class="n">unwrapped</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
    <span class="k">return</span> <span class="k">new</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;();</span>
<span class="p">}</span></code></pre></div>
<p>Просто, не так ли? Создадим функции для остальных операторов:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">OnDemand</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="n">ApplySpecialFunction</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;(</span>
  <span class="n">OnDemand</span><span class="p">&lt;</span><span class="n">A</span><span class="p">&gt;</span> <span class="n">onDemand</span><span class="p">,</span>
  <span class="n">Func</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">OnDemand</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;&gt;</span> <span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="p">()</span> <span class="p">=&gt;</span>
  <span class="p">{</span>
    <span class="n">A</span> <span class="n">unwrapped</span> <span class="p">=</span> <span class="n">onDemand</span><span class="p">();</span>
    <span class="n">OnDemand</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="n">result</span> <span class="p">=</span> <span class="n">function</span><span class="p">(</span><span class="n">unwrapped</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">();</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">Lazy</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="n">ApplySpecialFunction</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;(</span>
  <span class="n">Lazy</span><span class="p">&lt;</span><span class="n">A</span><span class="p">&gt;</span> <span class="n">lazy</span><span class="p">,</span>
  <span class="n">Func</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">Lazy</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;&gt;</span> <span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="k">new</span> <span class="n">Lazy</span><span class="p">(()</span> <span class="p">=&gt;</span>
  <span class="p">{</span>
    <span class="n">A</span> <span class="n">unwrapped</span> <span class="p">=</span> <span class="n">lazy</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
    <span class="n">Lazy</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="n">result</span> <span class="p">=</span> <span class="n">function</span><span class="p">(</span><span class="n">unwrapped</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">.</span><span class="n">Value</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">async</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="n">ApplySpecialFunction</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;(</span>
  <span class="n">Task</span><span class="p">&lt;</span><span class="n">A</span><span class="p">&gt;</span> <span class="n">task</span><span class="p">,</span>
  <span class="n">Func</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">Task</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;&gt;</span> <span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">A</span> <span class="n">unwrapped</span> <span class="p">=</span> <span class="k">await</span> <span class="n">task</span><span class="p">;</span>
  <span class="n">Task</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="n">result</span> <span class="p">=</span> <span class="n">function</span><span class="p">(</span><span class="n">unwrapped</span><span class="p">);</span>
  <span class="k">return</span> <span class="k">await</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="n">ApplySpecialFunction</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;(</span>
  <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">A</span><span class="p">&gt;</span> <span class="n">sequence</span><span class="p">,</span>
  <span class="n">Func</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;&gt;</span> <span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">foreach</span><span class="p">(</span><span class="n">A</span> <span class="n">unwrapped</span> <span class="k">in</span> <span class="n">sequence</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">IEnumerable</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="n">result</span> <span class="p">=</span> <span class="n">function</span><span class="p">(</span><span class="n">unwrapped</span><span class="p">);</span>
    <span class="k">foreach</span><span class="p">(</span><span class="n">R</span> <span class="n">r</span> <span class="k">in</span> <span class="n">result</span><span class="p">)</span>
      <span class="k">yield</span> <span class="k">return</span> <span class="n">r</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></div>
<p>В итоге для «шаблона монады» имеются 3 правила:</p>

<ol>
<li><p>Всегда существует возможность преобразовать тип <code>T</code> в тип <code>M&lt;T&gt;</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">M</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">CreateSimpleM</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="k">value</span><span class="p">)</span></code></pre></div></li>

<li><p>Если существует функция, преобразующая <code>A</code> в <code>R</code>, тогда можно применить эту функцию к экземпляру <code>M&lt;A&gt;</code> и получить экземпляр <code>M&lt;R&gt;</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">M</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="n">ApplyFunction</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;(</span>
<span class="n">M</span><span class="p">&lt;</span><span class="n">A</span><span class="p">&gt;</span> <span class="n">wrapped</span><span class="p">,</span>
<span class="n">Func</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;</span> <span class="n">function</span><span class="p">)</span></code></pre></div></li>

<li><p>Если существует функция, преобразующая <code>A</code> в <code>M&lt;R&gt;</code>, тогда можно применить эту функцию к экземпляру <code>M&lt;A&gt;</code> и получить экземпляр <code>M&lt;R&gt;</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">M</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="n">ApplySpecialFunction</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;(</span>
<span class="n">M</span><span class="p">&lt;</span><span class="n">A</span><span class="p">&gt;</span> <span class="n">wrapped</span><span class="p">,</span>
<span class="n">Func</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">M</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;&gt;</span> <span class="n">function</span><span class="p">)</span></code></pre></div></li>
</ol>

<p>Но, правило 2 является частным случаем правила 3. Его можно представить в как комбинацию 1 и 3 правила:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">M</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="n">ApplyFunction</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;(</span>
  <span class="n">M</span><span class="p">&lt;</span><span class="n">A</span><span class="p">&gt;</span> <span class="n">wrapped</span><span class="p">,</span>
  <span class="n">Func</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;</span> <span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">ApplySpecialFunction</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;(</span>
    <span class="n">wrapped</span><span class="p">,</span>
    <span class="p">(</span><span class="n">A</span> <span class="n">unwrapped</span><span class="p">)</span> <span class="p">=&gt;</span> <span class="n">CreateSimpleM</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;(</span><span class="n">function</span><span class="p">(</span><span class="n">unwrapped</span><span class="p">)));</span>
<span class="p">}</span></code></pre></div>
<p>Остается всего два правила. Они являются полными правилами «шаблона монады»? В принципе, да.</p>

<h3 id="часть-шестая">Часть шестая</h3>

<p>Необходимо, чтобы операции упаковки и распаковки сохраняли значение.</p>

<p>Пусть имеются 2 метода:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">M</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">CreateSimpleM</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
<span class="k">static</span> <span class="n">M</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="n">ApplySpecialFunction</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;(</span>
  <span class="n">M</span><span class="p">&lt;</span><span class="n">A</span><span class="p">&gt;</span> <span class="n">monad</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">M</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;&gt;</span> <span class="n">function</span><span class="p">)</span> <span class="p">{...}</span></code></pre></div>
<p>Тогда, результат следующего выражения:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">ApplySpecialFunction</span><span class="p">(</span><span class="n">someMonadValue</span><span class="p">,</span> <span class="n">CreateSimpleM</span><span class="p">)</span></code></pre></div>
<p>по значению идентичен <code>someMonadValue</code>, а результат следующего выражения:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">ApplySpecialFunction</span><span class="p">(</span><span class="n">CreateSimpleM</span><span class="p">(</span><span class="n">someValue</span><span class="p">),</span> <span class="n">someFunction</span><span class="p">)</span></code></pre></div>
<p>по значению идентичен:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">someFunction</span><span class="p">(</span><span class="n">someValue</span><span class="p">)</span></code></pre></div>
<h3 id="часть-седьмая">Часть седьмая</h3>

<p>Допустим, имеются 2 функции:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;&gt;</span> <span class="n">log</span> <span class="p">=</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">x</span> <span class="p">&gt;</span> <span class="m">0</span>
    <span class="p">?</span> <span class="k">new</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;(</span><span class="n">Math</span><span class="p">.</span><span class="n">Log</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="p">:</span> <span class="k">new</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">&gt;();</span>
<span class="n">Func</span><span class="p">&lt;</span><span class="kt">double</span><span class="p">,</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="kt">decimal</span><span class="p">&gt;&gt;</span> <span class="n">toDecimal</span> <span class="p">=</span> <span class="n">y</span> <span class="p">=&gt;</span> <span class="n">Math</span><span class="p">.</span><span class="n">Abs</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="p">&lt;</span> <span class="kt">decimal</span><span class="p">.</span><span class="n">MaxValue</span>
    <span class="p">?</span> <span class="k">new</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="kt">decimal</span><span class="p">&gt;((</span><span class="kt">decimal</span><span class="p">)</span><span class="n">y</span><span class="p">)</span>
    <span class="p">:</span> <span class="k">new</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="kt">decimal</span><span class="p">&gt;();</span></code></pre></div>
<p>Тогда, с помощью определенного ранее метода <code>ApplySpecialFunction</code> можно написать следующий метод-помощник:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">X</span><span class="p">,</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">Z</span><span class="p">&gt;&gt;</span> <span class="n">ComposeSpecial</span><span class="p">&lt;</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">&gt;(</span>
  <span class="n">Func</span><span class="p">&lt;</span><span class="n">X</span><span class="p">,</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">Y</span><span class="p">&gt;&gt;</span> <span class="n">f</span><span class="p">,</span>
  <span class="n">Func</span><span class="p">&lt;</span><span class="n">Y</span><span class="p">,</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="n">Z</span><span class="p">&gt;&gt;</span> <span class="n">g</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">return</span> <span class="n">x</span> <span class="p">=&gt;</span> <span class="n">ApplySpecialFunction</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">g</span><span class="p">);</span>
<span class="p">}</span></code></pre></div>
<p>который позволяет объединить определенные выше функции в одну:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">Func</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">,</span> <span class="n">Nullable</span><span class="p">&lt;</span><span class="kt">decimal</span><span class="p">&gt;&gt;</span> <span class="n">both</span> <span class="p">=</span> <span class="n">ComposeSpecial</span><span class="p">(</span><span class="n">log</span><span class="p">,</span> <span class="n">toDecimal</span><span class="p">);</span></code></pre></div>
<p>Отсюда следует последнее правило — метод <code>ApplySpecialFunction</code> должен гарантировать работу композиции. Пример:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="n">Func</span><span class="p">&lt;</span><span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">&lt;</span><span class="n">Y</span><span class="p">&gt;&gt;</span> <span class="n">f</span> <span class="p">=</span> <span class="n">whatever</span><span class="p">;</span>
<span class="n">Func</span><span class="p">&lt;</span><span class="n">Y</span><span class="p">,</span> <span class="n">M</span><span class="p">&lt;</span><span class="n">Z</span><span class="p">&gt;&gt;</span> <span class="n">g</span> <span class="p">=</span> <span class="n">whatever</span><span class="p">;</span>
<span class="n">M</span><span class="p">&lt;</span><span class="n">X</span><span class="p">&gt;</span> <span class="n">mx</span> <span class="p">=</span> <span class="n">whatever</span><span class="p">;</span>
<span class="n">M</span><span class="p">&lt;</span><span class="n">Y</span><span class="p">&gt;</span> <span class="n">my</span> <span class="p">=</span> <span class="n">ApplySpecialFunction</span><span class="p">(</span><span class="n">mx</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
<span class="n">M</span><span class="p">&lt;</span><span class="n">Z</span><span class="p">&gt;</span> <span class="n">mz1</span> <span class="p">=</span> <span class="n">ApplySpecialFunction</span><span class="p">(</span><span class="n">my</span><span class="p">,</span> <span class="n">g</span><span class="p">);</span>
<span class="n">Func</span><span class="p">&lt;</span><span class="n">X</span><span class="p">,</span> <span class="n">M</span><span class="p">&lt;</span><span class="n">Z</span><span class="p">&gt;&gt;</span> <span class="n">h</span> <span class="p">=</span> <span class="n">ComposeSpecial</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">);</span>
<span class="n">M</span><span class="p">&lt;</span><span class="n">Z</span><span class="p">&gt;</span> <span class="n">mz2</span> <span class="p">=</span> <span class="n">ApplySpecialFunction</span><span class="p">(</span><span class="n">mx</span><span class="p">,</span> <span class="n">h</span><span class="p">);</span></code></pre></div>
<p>Значения <code>mz1</code> и <code>mz2</code> должны быть одинаковыми.</p>

<p>Наконец, можно полностью описать «шаблон монады» в C#:</p>

<p>Монада — это обобщенный тип <code>M&lt;T&gt;</code>, такой что:</p>

<ul>
<li><p>Для нее существует конструирующий механизм, который принимает на вход переменную типа <code>T</code> и возвращает <code>M&lt;T&gt;</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">M</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;</span> <span class="n">CreateSimpleM</span><span class="p">&lt;</span><span class="n">T</span><span class="p">&gt;(</span><span class="n">T</span> <span class="n">t</span><span class="p">)</span></code></pre></div></li>

<li><p>Если существует способ преобразования значения типа <code>A</code> в <code>M&lt;R&gt;</code>, то можно применить эту функцию к экземпляру <code>M&lt;A&gt;</code> и получить экземпляр <code>M&lt;R&gt;</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-csharp" data-lang="csharp"><span class="k">static</span> <span class="n">M</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;</span> <span class="n">ApplySpecialFunction</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">R</span><span class="p">&gt;(</span>
<span class="n">M</span><span class="p">&lt;</span><span class="n">A</span><span class="p">&gt;</span> <span class="n">monad</span><span class="p">,</span> <span class="n">Func</span><span class="p">&lt;</span><span class="n">A</span><span class="p">,</span> <span class="n">M</span><span class="p">&lt;</span><span class="n">R</span><span class="p">&gt;&gt;</span> <span class="n">function</span><span class="p">)</span></code></pre></div></li>
</ul>

<p>Оба этих метода должны подчиняться следующим законам:</p>

<ul>
<li>Применение функции создающую простую монаду (правило-метод 1) к конкретному экземпляру монады должно приводить к логически идентичному экземпляру монады.</li>
<li>Применение функции к результату функции создающей простую монаду из определенного значения и применение этой функции к определенному значению напрямую должно приводить к логически идентичным экземплярам монад.</li>
<li>Результат применения к значению первой функции второй функции и результат применения первоначального значения к функции-композиции первых двух функций должен приводить к двум логически идентичным экземплярам монад.</li>
</ul>

<h3 id="часть-восьмая">Часть восьмая</h3>

<p>Традиционное имя для функции <code>CreateSimple</code> — <code>unit</code>. В Haskell — <code>return</code>.</p>

<p>Традиционное имя для функции <code>ApplySpecialFunction</code> — <code>bind</code>. В Haskell она является встроенной функцией, для того чтобы применить функцию <code>f</code> на экземпляр монады <code>m</code> необходимо написать <code>m &gt;&gt;= f</code>.</p>

<p>Фактически функция привязки берет неизменный рабочий процесс и операцию над ним и возвращает новый рабочий процесс.</p>

<p>Мой конспект на этом оканчивается. В последующих частях серии рассматривается практическое применение монад в коде.</p>

<ul>
<li><a href="http://ericlippert.com/2013/03/21/monads-part-nine/">Часть 9</a>. О простых монадах «присоединяющих дополнительные данные к значению».</li>
<li><a href="http://ericlippert.com/2013/03/25/monads-part-ten/">Часть 10</a>. О запросах и LINQ на примере <code>SelectMany</code>.</li>
<li><a href="http://ericlippert.com/2013/03/28/monads-part-eleven/">Часть 11</a>. Дополнения к предыдущей главе. Аддитивная монада.</li>
<li><a href="http://ericlippert.com/2013/04/02/monads-part-twelve/">Часть 12</a>. Продолжение про запросы и <code>SelectMany</code>.</li>
<li><a href="http://ericlippert.com/2013/04/03/monads-part-thirteen/">Часть 13</a>. О <code>Task</code> монадах.</li>
</ul>

    </div>

    <footer class="article-footer__wrapper">
      <div class="article-footer__meta">
  <span title="27 января 2016, 13:10 &#43;0300">2016</span>
    <div class="article-footer__meta-tags">
        <a class="article-footer__meta-tag" href="tags/dotnet">dotnet</a>
      
        <a class="article-footer__meta-tag" href="tags/functional">functional</a>
      </div>
  </div>

    </footer>
  </article>

  <article class="article-layout">
    <header class="article-head__wrapper">
      <div class="article-head">
        <a class="article-head__link" href="https://agladky.ru/blog/my-first-python-script/">Первый скрипт на Python</a>
      </div>
    </header>

    <div class="article-content markdown--blackfriday">
      

<p>Желание изучить питон было давно. Я много где слышал что он хорошо подходит для прототипов, скриптов и небольших приложений. Он отличается высокой скоростью разработки и низким порогом вхождения. Динамичность — непривычно, но решаемо.</p>

<p>И вот, написал первый скрипт. Он оптимизирует перемещение на «сегодня» просроченных задач в <a href="https://todoist.com/">тудуисте</a>. Перенос в приложении выполняется в 3 действия: выделить задачи с зажатым шифтом, пройти через пункты меню и нажать заветную кнопку: «перенести на сегодня». Это не всегда получается с одной попытки. Время для автоматизации!</p>

<h3 id="установка-python-3">Установка Python 3</h3>

<p>Не нашел причин, чтобы начать знакомство не с 3 версией питона. И, так как в Mac OS X El Capitan, установлена версия 2.7, то рассмотрим простой способ установки Python 3.</p>

<p>Понадобится менеджер пакетов <a href="http://brew.sh/">Homebrew</a>. У кого нет — советую. Для его установки введем в терминале:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">ruby -e <span class="s2">&#34;</span><span class="k">$(</span>curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install<span class="k">)</span><span class="s2">&#34;</span></code></pre></div>
<p>Теперь установим третий питон:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">brew install python3</code></pre></div>
<p>Проверить работоспособность можно набрав в консоли <code>python3</code>.</p>

<h3 id="получение-пакета-для-работы-с-тудуистом">Получение пакета для работы с тудуистом</h3>

<p>Следующий этап — установка библиотеки для работы с АПИ тудуиста. Воспользуемся менеджером пакетов pip3, который поставляется вместе с Python 3:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">pip3 install todoist-python</code></pre></div>
<p>Напоминаю о командной оболочке Zsh, о которой я <a href="http://www.agladky.ru/2015/11/zsh-bash.html">писал ранее</a>. Подключив плагины <code>brew</code> и <code>pip</code> можно добавить автодополнение для команд и пакетов.</p>

<h3 id="среда-разработки">Среда разработки</h3>

<p>Автодополнение, рефакторинг, отладка — все это помогает на любых стадиях изучения языка. Поэтому я воспользовался IDE от JetBrains — <a href="https://www.jetbrains.com/pycharm/">PyCharm CE</a>. Это бесплатная версия, в которой есть все необходимое.</p>

<h3 id="стиль-кода-и-именования">Стиль кода и именования</h3>

<p>Планирутся отдельная статья. А пока — о стиле именования.</p>

<p>Имена функций, методов и переменных экземпляров классов должны состоять из маленьких букв, а слова разделяться символами подчеркивания:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">foo_bar</span><span class="p">(</span><span class="n">new_value</span><span class="p">):</span></code></pre></div>
<p>Стиль mixedCase допускается в тех местах, где уже преобладает такой стиль, для сохранения обратной совместимости:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">def</span> <span class="nf">fooBar</span><span class="p">(</span><span class="n">newValue</span><span class="p">):</span></code></pre></div>
<p>Для атрибутов и непубличных методов используется один символ подчёркивания перед именем:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">_private_value</span> <span class="o">=</span> <span class="mi">3</span></code></pre></div>
<h3 id="итерация-и-получение-значений-из-коллекций">Итерация и получение значений из коллекций</h3>

<p>Библиотека todoist возвращает на запрос о просроченных задачах словарь или список. Возник вопрос: как работать с коллекциями?</p>

<p>Итерация оказалась похожа на <code>foreach</code> из C#:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">for</span> <span class="n">overdue_item</span> <span class="ow">in</span> <span class="n">overdue_items</span><span class="p">:</span>
    <span class="n">item</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">items</span><span class="o">.</span><span class="n">get_by_id</span><span class="p">(</span><span class="n">overdue_item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="k">print</span> <span class="n">item</span></code></pre></div>
<p>Для получения значения словаря есть 2 способа . Первый — обращение по ключу:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">id</span> <span class="o">=</span> <span class="n">overdue_item</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span></code></pre></div>
<p>Но, если значения нет, возникнет ошибка — <code>KeyError: 'id'</code>. Поэтому при неуверенности, используйте <code>get</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="nb">id</span> <span class="o">=</span> <span class="n">overdue_item</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span></code></pre></div>
<p>Если значение отсутствует, метод вернет значение по умолчанию — <code>None</code>.</p>

<h3 id="преобразование-и-работа-с-датой">Преобразование и работа с датой</h3>

<p>Рассмотрим как парсить дату, находить дельту, добавлять значения и приводить к определенному строковому формату.</p>

<p>Разберем построчно код из моего скрипта:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">item_due_date</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">item</span><span class="p">[</span><span class="s1">&#39;due_date_utc&#39;</span><span class="p">],</span> <span class="s1">&#39;%a </span><span class="si">%d</span><span class="s1"> %b %Y %H:%M:%S %z&#39;</span><span class="p">)</span>
<span class="n">delta</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="o">-</span> <span class="n">item_due_date</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
<span class="n">item_today_date</span> <span class="o">=</span> <span class="n">item_due_date</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="n">delta</span><span class="o">.</span><span class="n">days</span><span class="p">)</span>
<span class="n">item</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">due_date_utc</span><span class="o">=</span><span class="n">item_today_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">T%H:%M:%S&#39;</span><span class="p">))</span></code></pre></div>
<ol>
<li>По ключу <code>due_date_utc</code> получаем дату в формате <code>&quot;Fri 26 Sep 2014 08:25:05 +0000&quot;</code>. Выражением <code>%a %d %b %Y %H:%M:%S %z</code> переводим в понятный питону формат. <a href="https://docs.python.org/3/library/datetime.html#strftime-and-strptime-behavior">Документация</a> по значениям переменных из выражения.</li>
<li>Находим разницу между текущей датой и датой полученного объекта.</li>
<li>Актуализируем дату объекта, добавляя к нему полученную разницу дней.</li>
<li>Переведем дату в строку используя <code>%Y-%m-%dT%H:%M:%S</code> и отправим изменения в тудуист.</li>
</ol>

<h3 id="типы-выполнения-модуля-с-кодом">Типы выполнения модуля с кодом</h3>

<p>Часто, читая код на гитхабе, встречал конструкцию:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&#34;__main__&#34;</span><span class="p">:</span>
    <span class="o">...</span></code></pre></div>
<p>Выясним ее предназначение.</p>

<p>Когда исполняется файл с кодом, выполняются все команды на нулевом уровне: задаются специальные переменные, импортируются модули, определяются функции и классы. Одна из специальных переменных — <code>__name__</code>. Она хранит имя модуля, который вызвал скрипт.</p>

<p>Например, модуль вызвали из файла <code>foo.py</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="kn">import</span> <span class="nn">TodoistOverdue</span></code></pre></div>
<p>Переменная <code>__name__</code> примет значение <code>foo</code>. Если вызвать скрипт напрямую из терминала:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">python TodoistOverdue.py</code></pre></div>
<p><code>__name__</code> инициализируется значением <code>__main__</code>. И тогда выполнится весть код из условия <code>if __name__ == &quot;__main__&quot;:</code>. Получается, модуль может работать и библиотекой и независимым приложением.</p>

<h3 id="добавление-атрибутов-командной-строки">Добавление атрибутов командной строки</h3>

<p>Мой скрипт может принимать значение токена АПИ тудуиста. Для этого скрипт вызывается с параметром <code>-t</code>:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh">python TodoistOverdue.py -t 0123456789abcdef0123456789abcdef01234567</code></pre></div>
<p>Рассмотрим построчно, как задавать описание скрипта и определять аргументы:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&#34;Moving overdue tasks for today in todoist&#34;</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&#34;-t&#34;</span><span class="p">,</span> <span class="s2">&#34;--token&#34;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&#34;Todoist API token&#34;</span><span class="p">)</span>
<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span></code></pre></div>
<ol>
<li>Инициализируем класс <code>ArgumentParser</code>, помогающий работать с командной строкой, и зададим описание скрипта.</li>
<li>Добавим аргумент, задаваемый ключом <code>’-t’</code> или <code>’--token’</code>. В параметре <code>help</code> указываем описание, показываемое при вызове скрипта с ключом <code>-h</code>.</li>
<li>Переводим строки аргументов в объекты и присваиваем их как атрибуты к переменной.</li>
</ol>

<p>Теперь, при запуске скрипта с ключом <code>-t</code>, в переменной <code>args.token</code> будет храниться значение введенного токена. Про остальные параметры и методы можно узнать в <a href="https://docs.python.org/3.5/library/argparse.html">документации python</a>.</p>

<h3 id="чтение-и-запись-в-файл-конфигурации">Чтение и запись в файл конфигурации</h3>

<p>Полученный токен хранится в конфигурационном файле. Рассмотрим код для доступа, чтения и записи значения:</p>

<h3 id="чтение-и-запись-в-файл-конфигурации-1">Чтение и запись в файл конфигурации</h3>

<p>Полученный токен хранится в конфигурационном файле. Рассмотрим код для доступа, чтения и записи значения:</p>
<div class="highlight"><pre class="chroma"><code class="language-python" data-lang="python"><span class="n">config</span> <span class="o">=</span> <span class="n">configparser</span><span class="o">.</span><span class="n">ConfigParser</span><span class="p">()</span>
<span class="n">config</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;/.todoist&#34;</span><span class="p">)</span>
<span class="n">token</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">token</span>
<span class="k">if</span> <span class="n">token</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
    <span class="n">token</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Global&#39;</span><span class="p">][</span><span class="s1">&#39;TokenAPI&#39;</span><span class="p">]</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">config</span><span class="p">[</span><span class="s1">&#39;Global&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;TokenAPI&#39;</span><span class="p">:</span> <span class="n">token</span><span class="p">}</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">expanduser</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;/.todoist&#34;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">configfile</span><span class="p">:</span>
        <span class="n">config</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">configfile</span><span class="p">)</span></code></pre></div>
<ol>
<li>Инициализируем <code>ConfigParser</code> и читаем файл из домашней директории пользователя. <code>expanduser('~')</code> позволяет получить путь к домашней директории в любой операционной системе.</li>
<li>Читаем конфиг как словарь: <code>config['Global']['TokenAPI']</code>. Сначала обращаемся к секции со значением, следом — к ключу.</li>
<li>В блоке <code>else</code> записываем значение токена, если оно было указано при запуске. После конфигурационный файл записывается на диск.</li>
</ol>

<p>Мне понравилось, как просто записать изменения в файл. В C# для этого надо открывать потоки, указывать дополнительную информацию, здесь это просто 2 строчки. Возьми это и запиши сюда, все.</p>

<p><a href="https://docs.python.org/3/library/configparser.html">Документация</a> для ConfigParser. <a href="https://docs.python.org/3.5/tutorial/inputoutput.html">Информацию о вводе и выводе</a> в Python 3.</p>

<h3 id="заключение">Заключение</h3>

<p>Знакомство с языком Python оставило приятное впечатление. Как минимум его стоит изучить на базовом уровне, чтобы автоматизировать происходящие вокруг вас процессы. Он также хорош для быстрого написания прототипа идеи, засевшей у вас в голове.</p>

<p>Полный скрипт <code>TodoistOverdue.py</code> из статьи лежит в <a href="https://gist.github.com/agladky/f7853721841bc4486712">gist</a>.</p>

<h3 id="полезные-ссылки">Полезные ссылки</h3>

<p>— Как запускать скрипты в Mac Os X без указания полного пути. <a href="http://stackoverflow.com/questions/4718071/how-can-i-run-my-python-script-from-the-terminal-in-mac-os-x-without-having-to-t">Stackoverflow</a>.
— Изучить питон за несколько минут (learnxinyminutes.com). <a href="https://learnxinyminutes.com/docs/ru-ru/python3-ru/">Русская</a> и <a href="https://learnxinyminutes.com/docs/python3/">английская</a> версия.
— Документация для <a href="https://docs.python.org/3.5/index.html">Python 3.5.х</a>.</p>

    </div>

    <footer class="article-footer__wrapper">
      <div class="article-footer__meta">
  <span title="20 января 2016, 13:10 &#43;0300">2016</span>
    <div class="article-footer__meta-tags">
        <a class="article-footer__meta-tag" href="tags/python">python</a>
      </div>
  </div>

    </footer>
  </article>

  <article class="article-layout">
    <header class="article-head__wrapper">
      <div class="article-head">
        <a class="article-head__link" href="https://agladky.ru/blog/git-cheat-sheet/">Шпаргалка с основными командами для Git</a>
      </div>
    </header>

    <div class="article-content markdown--blackfriday">
      

<h3 id="конфигурация">Конфигурация</h3>

<p><code>git config --global user.name &quot;[name]&quot;</code> — установить имя, которое будет прикрепляться к коммиту.</p>

<p><code>git config --global user.email &quot;[email address]&quot;</code> — установить email, который будет прикрепляться к коммиту.</p>

<p><code>git config --global color.ui auto</code> — включить полезную подсветку командной строки.</p>

<p><code>git config --global push.default current</code> — обновлять удаленную ветку с таким же именем, что и локальная, при пуше изменений (если не указано иного).</p>

<p><code>git config --global core.editor [editor]</code> — установить редактор для редактирования сообщений коммита.</p>

<p><code>git config --global diff.tool [tool]</code> — установить программу для разрешения конфликтов при слиянии.</p>

<h3 id="создание-репозиториев">Создание репозиториев</h3>

<p><code>git init [project-name]</code> — создать новый локальный репозиторий с заданным именем.</p>

<p><code>git clone [url]</code> — загрузить проект и его полную историю изменений.</p>

<h3 id="работа-с-изменениями">Работа с изменениями</h3>

<p><code>git status</code> — полный список изменений файлов, ожидающих коммита.</p>

<p><code>git status -s</code> — краткий вид изменений.</p>

<p><code>git diff</code> — показать изменения в файлах, которые еще не были добавлены в индекс коммита (staged).</p>

<p><code>git add [file]</code> — сделать указанный файл готовым для коммита.</p>

<p><code>git add .</code> — сделать все измененные файлы готовыми для коммита.</p>

<p><code>git add '*.txt'</code> — добавить только файлы, соответствующие указанному выражению.</p>

<p><code>git add --patch filename</code> — позволяет выбрать какие изменения из файла добавятся в коммит.</p>

<p><code>git diff --staged</code> — показать что было добавленно в индекс с помощью <code>git add</code>, но еще не было закоммиченно.</p>

<p><code>git diff HEAD</code> — показать что изменилось с последнего коммита.</p>

<p><code>git diff HEAD^</code> — показать что изменилось с предпоследнего коммита.</p>

<p><code>git diff [branch]</code> — сравнить текущую ветку с заданной.</p>

<p><code>git difftool -d</code> — то же самое, что и <code>diff</code>, но показывает изменения в заданной difftool.</p>

<p><code>git difftool -d master..</code> — показать изменения, сделанные в текущей ветке.</p>

<p><code>git diff --stat</code> — показать статистику какие файлы были изменены и как.</p>

<p><code>git reset [file]</code> — убрать файлы из индекса коммита (изменения не теряются).</p>

<p><code>git commit</code> — записать изменения в репозиторий. для написания сообщения откроется назначенный редактор.</p>

<p><code>git commit -m &quot;[descriptive message]&quot;</code> — записать изменения с заданным сообщением.</p>

<p><code>git commit --amend</code> — добавить изменения к последнему коммиту.</p>

<h3 id="работа-с-ветками">Работа с ветками</h3>

<p><code>git branch</code> — список всех локальных веток в текущей директории.</p>

<p><code>git branch [branch-name]</code> — создать новую ветку.</p>

<p><code>git checkout [branch-name]</code> — переключиться на указанную ветку и обновить рабочую директорию.</p>

<p><code>git checkout -b &lt;name&gt; &lt;remote&gt;/&lt;branch&gt;</code> — переключиться на удаленную ветку.</p>

<p><code>git checkout [filename]</code> — вернуть файл в первоначальное состояние если он еще не был добавлен в индекс коммита.</p>

<p><code>git merge [branch]</code> — соединить изменения в текущей ветке с изменениями из заданной.</p>

<p><code>git merge --no-ff [branch]</code> — соединить ветки без режима &ldquo;<a href="http://zencoder.ru/git/fast-forward-git">fast forwarding</a>&rdquo;.</p>

<p><code>git branch -a</code> — посмотреть полный список локальных и удаленных веток.</p>

<p><code>git branch -d [branch]</code> — удалить заданную ветку.</p>

<p><code>git branch -D [branch]</code> — принудительно удалить заданную ветку, игнорируя ошибки.</p>

<p><code>git branch -m &lt;oldname&gt; &lt;newname&gt;</code> — переименовать ветку.</p>

<h3 id="работа-с-файлами">Работа с файлами</h3>

<p><code>git rm [file]</code> — удалить файл из рабочей директории и добавить в индекс информацию об удалении.</p>

<p><code>git rm --cached [file]</code> — удалить файл из репозитория, но сохранить его локально.</p>

<p><code>git mv [file-original] [file-renamed]</code> — изменить имя файла и добавить в индекс коммита.</p>

<h3 id="отслеживание-файлов">Отслеживание файлов</h3>

<p><code>.gitignore</code> — текстовый файл, в котором задаются правила для исключения файлов из репозитория. Например:</p>

<ul>
<li><code>*.log</code></li>
<li><code>build/</code></li>
<li><code>temp-*</code></li>
</ul>

<p><code>git ls-files --other --ignored --exclude-standard</code> — список всех игнорируемых файлов.</p>

<h3 id="сохранение-фрагментов">Сохранение фрагментов</h3>

<p><code>git stash</code> — положить во временное хранилище все отслеживаемые файлы.</p>

<p><code>git stash pop</code> — восстановить последние файлы, положенные во временное хранилище.</p>

<p><code>git stash list</code> — список всех сохраненных изменений во временном хранилище.</p>

<p><code>git stash drop</code> — удалить последние файлы, положенные во временное хранилище.</p>

<h3 id="просмотр-истории">Просмотр истории</h3>

<p><code>git log</code> — список изменения текущей ветки.</p>

<p><code>git log --follow [file]</code> — список изменения текущего файла, включая переименования.</p>

<p><code>git log --pretty=format:&quot;%h %s&quot; --graph</code> — изменение вида отображения истории изменений.</p>

<p><code>git log --author='Name' --after={1.week.ago} --pretty=oneline --abbrev-commit</code> — посмотреть над чем работал заданный пользователь последнюю неделю.</p>

<p><code>git log --no-merges master..</code> — посмотреть историю изменений только для текущей ветки.</p>

<p><code>git diff [file-branch]..[second-branch]</code> — посмотреть различия между двумя заданными ветками.</p>

<p><code>git show [commit]</code> — показать метадату и изменения в заданном коммите.</p>

<p><code>git show [branch]:[file]</code> — посмотреть на файл в другой ветке, не переключаясь на неё.</p>

<h3 id="отмена-коммитов">Отмена коммитов</h3>

<p><code>git reset</code> — убрать изменения из индекса коммита, сами изменения останутся.</p>

<p><code>git reset [commit/tag]</code> — отменить все коммиты после указанного коммита, изменения будут сохранены локально.</p>

<p><code>git reset --hard [commit]</code> — принудительно вернутся к указанному коммиту, не сохраняя историю и изменения.</p>

<h3 id="синхронизация-изменений">Синхронизация изменений</h3>

<p><code>git fetch [bookmark]</code> — загрузить всю историю с заданного удаленного репозитория.</p>

<p><code>git merge [bookmark]/[branch]</code> — слить изменения локальной ветки и заданной удаленной.</p>

<p><code>git push</code> — запушить текущую ветку в удаленную ветку.</p>

<p><code>git push [remote] [branch]</code> — запушить ветку в указанный репозиторий и удаленную ветку.</p>

<p><code>git push [bookmark] :[branch]</code> — в удаленном репозитории удалить заданную ветку.</p>

<p><code>git push -u origin master</code> — если удаленная ветка не установлена как отслеживаемая, то сделать ее такой.</p>

<p><code>git pull</code> — загрузить историю и изменения удаленной ветки и произвести слияние с текущей веткой.</p>

<p><code>git pull [remote][branch]</code> — указать конкретную удаленную ветку для слияния.</p>

<p><code>git remote</code> — посмотреть список доступных удаленных репозиториев.</p>

<p><code>git remote -v</code> — посмотреть детальный список доступных удаленных репозиториев.</p>

<p><code>git remote add [remote][url]</code> — добавить новый удаленный репозиторий.</p>

<h3 id="полезные-ссылки">Полезные ссылки</h3>

<ul>
<li>19 советов по повседневной работе с Git. <a href="http://www.alexkras.com/19-git-tips-for-everyday-use/">оригинал</a>. <a href="http://habrahabr.ru/company/mailru/blog/267595/">перевод</a>.</li>
<li>Книга &ldquo;<a href="http://git-scm.com/book/ru/v1">Pro Git</a>&rdquo;. Издание первое, на русском.</li>
<li>Книга &ldquo;<a href="http://git-scm.com/book/en/v2">Pro Git</a>&rdquo;. Издание второе, на английском.</li>
<li>Git Rebase: <a href="http://habrahabr.ru/post/161009/">руководство по использованию</a>.</li>
</ul>

    </div>

    <footer class="article-footer__wrapper">
      <div class="article-footer__meta">
  <span title="6 января 2016, 13:10 &#43;0300">2016</span>
    <div class="article-footer__meta-tags">
        <a class="article-footer__meta-tag" href="tags/git">git</a>
      </div>
  </div>

    </footer>
  </article>

  <article class="article-layout">
    <header class="article-head__wrapper">
      <div class="article-head">
        <a class="article-head__link" href="https://agladky.ru/blog/why-zsh-is-better-than-bash/">Почему стоит использовать zsh вместо bash</a>
      </div>
    </header>

    <div class="article-content markdown--blackfriday">
      

<p>Zsh не такая уж и новая оболочка, первая версия появилась еще в 1990 году. С историей и основными особенностями можно познакомиться в <a href="https://ru.wikipedia.org/wiki/Zsh">русской</a> или <a href="https://en.wikipedia.org/wiki/Z_shell">английской</a> википедии.</p>

<p>Давайте рассмотрим особенности zsh, которые покажут чем эта оболочка лучше bash. И почему стоит хотя бы попробовать использовать её в повседневной жизни.</p>

<h3 id="автодополнение-для-cd">Автодополнение для cd</h3>

<p>Наберем в баш <code>cd</code> и нажмем таб.</p>




    


<figure>
	<img src="https://agladky.ru/blog/why-zsh-is-better-than-bash/images/bash-cd-tab-first_hu1ce81721fbd96c6f68f8565a2c1ea347_65739_1000x0_resize_q100_box_2.png" alt="bash cd tab first">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>Еще раз.</p>




    


<figure>
	<img src="https://agladky.ru/blog/why-zsh-is-better-than-bash/images/bash-cd-tab-second_hucf282d50c84dc6d5f7e208a899c25811_99710_1000x0_resize_q100_box_2.png" alt="bash cd tab second">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>Каждый раз будет выводиться только список файлов в текущей директории. Так продолжится пока не ввести первые буквы искомого файла, тогда отобразиться отфильтрованный список. И только если введенные данные позволяют точно определить значение, то подставится полное имя файла или папки.</p>

<p>Теперь наберем <code>cd</code> в zsh и нажмем таб.</p>




    


<figure>
	<img src="https://agladky.ru/blog/why-zsh-is-better-than-bash/images/zsh-cd-tab-first_hu3649e35cdc114eeffa1642faccda59bd_65258_1000x0_resize_q100_box_2.png" alt="zsh cd tab first">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>В строку ввода подставилось первое значение из списка. Нажимаем таб еще раз.</p>




    


<figure>
	<img src="https://agladky.ru/blog/why-zsh-is-better-than-bash/images/zsh-cd-tab-second_hu3649e35cdc114eeffa1642faccda59bd_71366_1000x0_resize_q100_box_2.png" alt="zsh cd tab second">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>Подставилось второе значение из списка! Удобно.</p>

<h3 id="автодополнение-для-команд-на-примере-git">Автодополнение для команд на примере git</h3>

<p>Введем в баш <code>git</code> и нажмем таб.</p>




    


<figure>
	<img src="https://agladky.ru/blog/why-zsh-is-better-than-bash/images/bash-git-tab_hucf865b07bb521cee8aae6ad4b1fd7db4_69596_1000x0_resize_q100_box_2.png" alt="bash git tab">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>Никакой помощи не появилось. Только отображаются файлы данной директории.</p>

<p>Проделаем ту же операцию в zsh.</p>




    


<figure>
	<img src="https://agladky.ru/blog/why-zsh-is-better-than-bash/images/zsh-git-tab_hu03300f966fd8ae1ac2ad69108a315d31_189144_1000x0_resize_q100_box_2.png" alt="zsh git tab">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>Отобразился список команд с описанием. Это гораздо информативнее.</p>

<p>Да, установив пакет bash-completion, подобное поведение появится и в баше. Но выводить информацию как в zsh не получится:</p>

<ul>
<li>Не будет итерации по значениям, как в пункте про <code>cd</code>;</li>
<li>Не будет справочной информации, только список значений.</li>
</ul>

<h3 id="раскрытие-полного-пути">Раскрытие полного пути</h3>

<p>Zsh поддерживает раскрытие полного пути на основе неполных данных. Введем шаблон пути:</p>




    


<figure>
	<img src="https://agladky.ru/blog/why-zsh-is-better-than-bash/images/zsh-path-expansion-first_hudd8239d04b450c92f709011ee324f669_34826_1000x0_resize_q100_box_2.png" alt="zsh path expansion first">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>Нажмем tab.</p>




    


<figure>
	<img src="https://agladky.ru/blog/why-zsh-is-better-than-bash/images/zsh-path-expansion-second_hu3090c863184f469e2c4c382ebc6a1243_36631_1000x0_resize_q100_box_2.png" alt="zsh path expansion second">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>Путь до директории полностью раскрылся. Не пришлось вводить лишних символов.</p>

<p>Но что, если заданному пути соответствует несколько путей? Введем <code>cd u/l/g</code> и нажмем таб.</p>




    


<figure>
	<img src="https://agladky.ru/blog/why-zsh-is-better-than-bash/images/zsh-path-expansion-third_hudd8239d04b450c92f709011ee324f669_34328_1000x0_resize_q100_box_2.png" alt="zsh path expansion third">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>Путь раскрылся до возникновения неопределенности. Нажимаем таб еще раз, и перед нами предстанет выбор папки.</p>




    


<figure>
	<img src="https://agladky.ru/blog/why-zsh-is-better-than-bash/images/zsh-path-expansion-fourth_hu1b01d49ba921e012625af7846d13510e_43085_1000x0_resize_q100_box_2.png" alt="zsh path expansion fourth">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>Выбираем табом нужную папку. Последующее нажатие таба раскроет задуманный путь до конца.</p>

<h3 id="замена-пути">Замена пути</h3>

<p>Zsh поддерживает замену части пути. Рассмотрим на примере. Введем <code>cd /usr/local/bin</code>. Но подождите, я хотел <code>cd /usr/local/share</code>! Не проблема, вводим команду <code>cd bin share</code> и получаем заветный путь:</p>




    


<figure>
	<img src="https://agladky.ru/blog/why-zsh-is-better-than-bash/images/zsh-path-replacement-first_huc7aa161642077ec4358160303cc4aaee_60678_1000x0_resize_q100_box_2.png" alt="zsh path replacement first">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>Возможно, это не самый убедительный пример. Того же эффекта можно достичь просто написав <code>cd ../share</code>. Но рассмотрим следующий случай:</p>




    


<figure>
	<img src="https://agladky.ru/blog/why-zsh-is-better-than-bash/images/zsh-path-replacement-second_hu0509c2a5874635db8a2d50a5900a46b7_64080_1000x0_resize_q100_box_2.png" alt="zsh path replacement second">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>B баш тут бы пришлось изрядно постараться (<code>cd ../../../</code>).</p>

<h3 id="псевдонимы">Псевдонимы</h3>

<p>Обычные псевдонимы задаются так:</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">alias</span> <span class="nv">ls</span><span class="o">=</span>’ls —color<span class="o">=</span>auto’</code></pre></div>
<p>В zsh существует еще 2 типа псевдонима.</p>

<p>Первый — <em>глобальный (global)</em>. Может вызываться в любом месте команды. Задается ключом <code>-g</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">alias</span> -g <span class="nv">gp</span><span class="o">=</span><span class="s1">&#39;| grep -i&#39;</span>

$ ps ax gp <span class="nv">docker</span>
<span class="o">=</span>&gt; ps ax <span class="p">|</span> grep -i docker</code></pre></div>
<p>В примере, вместо написания <code>| grep -i</code>, в середине выражения, использовался псевдоним <code>gp</code>. Удобно.</p>

<p>Второй тип — <em>суффиксный (suffix)</em>. Указывает в каком приложении открывать файл, основываясь на расширении. Задается ключом <code>-s</code>.</p>
<div class="highlight"><pre class="chroma"><code class="language-sh" data-lang="sh"><span class="nb">alias</span> -s <span class="nv">log</span><span class="o">=</span><span class="s1">&#39;less -MN&#39;</span>
<span class="nb">alias</span> -s <span class="nv">html</span><span class="o">=</span><span class="s1">&#39;chromium&#39;</span>

$ development.log
<span class="o">=</span>&gt; less -MN development.log
$ index.html
<span class="o">=</span>&gt; chromium index.html</code></pre></div>
<h3 id="правая-строка">Правая строка</h3>

<p>Zsh позволяет настроить правую строку приглашения. Туда можно выводить текущую дату, состояние ветки в git и многое другое. Иллюстрация из <a href="https://git-scm.com/book/tr/v2/Git-in-Other-Environments-Git-in-Zsh">книги Pro Git</a>:</p>




    


<figure>
	<img src="https://agladky.ru/blog/why-zsh-is-better-than-bash/images/zsh-right-prompt-example.png" alt="zsh right prompt example">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<h3 id="поиск-в-истории-по-подстроке">Поиск в истории по подстроке</h3>

<p>Одна из самых кайфовых вещей, которую позволяет делать zsh. (Включается плагином, history-substring-search в oh-my-zsh, о котором ниже).</p>

<p>Например, вводим <code>git pu</code> и нажимаем стрелку вверх.</p>




    


<figure>
	<img src="https://agladky.ru/blog/why-zsh-is-better-than-bash/images/zsh-history-substring-search_hufadef811aa32d4d1419077222fb16b50_37862_1000x0_resize_q100_box_2.png" alt="zsh history substring search">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<p>Получили последний запрос, который соответствует введенному шаблону. Дальнейшие нажатия будут выводить следующий результат. Удобно, что для поиска совершаются минимальные действия.</p>

<h3 id="oh-my-zsh">oh-my-zsh</h3>

<p>Фреймворк для легкой настройки и установки <a href="https://github.com/robbyrussell/oh-my-zsh/wiki/Plugins-Overview">плагинов</a> и <a href="https://github.com/robbyrussell/oh-my-zsh/wiki/Themes">тем оформления</a>. Содержит в себе уже более 200 плагинов. Проект доступен на <a href="https://github.com/robbyrussell/oh-my-zsh">github</a>.</p>

<p>Плагины которыми я пользуюсь:
* <em>git</em> — добавляет много полезных <a href="https://github.com/robbyrussell/oh-my-zsh/wiki/Plugin:git">сокращений</a> для команд гита.
* <em>colored-man-pages</em> — добавляет подсветку на man страницы
* <em>command-not-found</em> — подсказывает название команды, если она напечатана с ошибкой
* <em>bwana</em> — позволяет открывать man страницы в браузере
* <em>sublime</em> — псевдонимы для вызова sublime text
* <em>history</em> — псевдонимы для истории команд и поиска по ним
* <em>history-substring-search</em> — реализация поиска в истории по подстроке
* <em>docker</em> — помощь для команд докера.</p>

<p>Вид популярной темы для zsh:</p>




    


<figure>
	<img src="https://agladky.ru/blog/why-zsh-is-better-than-bash/images/popular-zsh-theme.png" alt="popular zsh theme">
	<figcaption style="font-size: 0.8rem"></figcaption>
</figure>


<h3 id="заключение">Заключение</h3>

<p>Я не сомневаюсь, что многое из написанного можно достигнуть с помощью различных плагинов и скриптов для баша. Но зачем если есть хорошее решение «из коробки». Которое работает, и работает очень хорошо.</p>

    </div>

    <footer class="article-footer__wrapper">
      <div class="article-footer__meta">
  <span title="26 ноября 2015, 13:10 &#43;0300">2015</span>
    <div class="article-footer__meta-tags">
        <a class="article-footer__meta-tag" href="tags/shell">shell</a>
      </div>
  </div>

    </footer>
  </article>



  <nav>
    
    
      <a href="https://agladky.ru/blog/page/2/">Позднее →</a>
    
  </nav>



        </div>
      </main>

      <footer class="footer-layout__container section-skin">
        <div>
          <div>
            <span>© Анатолий Гладкий, 2019</span>
            <a class="footer__rss" href="https://agladky.ru/index.xml">РСС</a>
          </div>
          <span>Эл. почта: <a href="mailto:me@agladky.ru">me@agladky.ru</a></span>
        </div>
      </footer>
    </div>
    
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-75808442-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  </body>
</html>
  
